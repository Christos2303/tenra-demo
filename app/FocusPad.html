<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tenra ‚Äî FocusPad</title>
  <meta name="color-scheme" content="light dark" />

  <style>
    :root{
      --bg: radial-gradient(1200px 800px at 20% 0%, #0f1115 0%, #0b0d10 45%, #07080b 100%);
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.12);
      --text: #EDEEF2;
      --muted: #A7ADB8;
      --gold: #d4af37; /* warm gold */
      --gold-2: #b9962a;
      --shadow: 0 10px 40px rgba(0,0,0,0.45);
      --radius: 22px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display","Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    .wrap{
      min-height: 100dvh;
      padding: clamp(16px, 2.5vw, 28px);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 16px;
      animation: fadeIn .6s ease both;
    }

    @keyframes fadeIn{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform:none;} }

    /* Topbar */
    .topbar{
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(14px) saturate(130%);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px 18px;
      box-shadow: var(--shadow);
    }
    .brand{
      display: flex; align-items: center; gap: 12px;
    }
    .logo{
      width: 36px; height: 36px; border-radius: 12px;
      background: radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,0.35), rgba(255,255,255,0.05) 35%) , linear-gradient(135deg,#0f1218 0%, #12151c 100%);
      border: 1px solid var(--stroke);
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 4px 18px rgba(0,0,0,0.35);
    }
    .logo::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 12px;
      background: linear-gradient(140deg, rgba(212,175,55,0.4), rgba(185,150,42,0.15) 40%, transparent 70%);
      pointer-events:none;
    }
    .brand h1{
      margin: 0;
      font-size: clamp(18px, 2vw, 22px);
      letter-spacing: 0.3px;
      font-weight: 600;
    }
    .meta{
      display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 14px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius: 999px; background: var(--glass);
      border: 1px solid var(--stroke);
    }
    .gold-dot{
      width:8px; height:8px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffe9a3, #d4af37);
      box-shadow: 0 0 10px rgba(212,175,55,0.6);
    }
    .btn{
      appearance: none; border: 1px solid var(--stroke); border-radius: 12px;
      padding: 10px 14px; color: var(--text); background: var(--glass);
      backdrop-filter: blur(10px); cursor: pointer; transition: transform .2s ease, border-color .2s, background .2s;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(212,175,55,0.45); background: var(--glass-2); }
    .btn.gold{
      border: 1px solid rgba(212,175,55,0.55);
      background: linear-gradient(180deg, rgba(212,175,55,0.22), rgba(212,175,55,0.12));
      box-shadow: inset 0 0 0 0.5px rgba(255,255,255,0.1), 0 6px 24px rgba(212,175,55,0.12);
    }

    /* Grid */
    .grid{
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: clamp(14px, 1.6vw, 20px);
      align-content: start;
    }
    .hero{
      grid-column: 1 / -1;
      display: grid; grid-template-columns: 1.35fr 1fr; gap: 16px;
    }
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
    }

    .card{
      position: relative;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      backdrop-filter: blur(14px) saturate(140%);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .glow{
      position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(800px 300px at 10% 0%, rgba(212,175,55,0.16), transparent 45%),
                  radial-gradient(800px 300px at 90% 100%, rgba(212,175,55,0.10), transparent 55%);
      opacity: .9;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding: 18px 20px 8px 20px;
    }
    .card-title{
      margin:0; font-weight:600; letter-spacing:.2px;
    }
    .sub{ color: var(--muted); font-size: 14px; }

    /* App tiles */
    .apps{
      grid-column: 1 / -1;
      display: grid; grid-template-columns: repeat(12, 1fr); gap: clamp(14px, 1.6vw, 20px);
      margin-top: 6px;
    }
    .tile{
      grid-column: span 4;
      min-height: 180px;
      border-radius: calc(var(--radius) + 2px);
      border: 1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02)),
        radial-gradient(80% 120% at 80% 0%, rgba(212,175,55,0.18), transparent 60%);
      backdrop-filter: blur(14px) saturate(140%);
      box-shadow: var(--shadow);
      position: relative; overflow: hidden;
      cursor: pointer; transition: transform .22s ease, border-color .22s ease, box-shadow .22s ease;
    }
    @media (max-width: 980px){ .tile{ grid-column: span 12; } }
    .tile:hover{
      transform: translateY(-4px);
      border-color: rgba(212,175,55,0.45);
      box-shadow: 0 20px 60px rgba(212,175,55,0.10), var(--shadow);
    }
    .tile::after{
      content:""; position:absolute; inset:-1px; border-radius: inherit;
      background: linear-gradient(140deg, rgba(255,255,255,0.08), rgba(212,175,55,0.20) 35%, rgba(0,0,0,0) 66%);
      mix-blend-mode: screen; opacity:.7; pointer-events:none;
    }
    .tile-body{
      position: absolute; inset: 0; padding: 22px;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .tile h3{ margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .3px; }
    .tile p{ margin: 0; color: var(--muted); font-size: 14px; max-width: 60ch; }
    .badge{
      align-self: flex-start; margin-top: 8px;
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px; font-size:12px; color: var(--text);
      border:1px solid rgba(212,175,55,0.45);
      background: linear-gradient(180deg, rgba(212,175,55,0.20), rgba(212,175,55,0.10));
      box-shadow: inset 0 0 0 0.5px rgba(255,255,255,0.1);
    }

    .tile-icon{
      position:absolute; right: -10px; bottom: -12px; opacity:.45;
      filter: drop-shadow(0 6px 24px rgba(0,0,0,0.35));
      transform: rotate(-6deg);
      font-size: 96px; line-height: 1; user-select: none; pointer-events:none;
    }

    /* Modal firm chooser */
    dialog{
      width: min(560px, 92vw);
      border: 1px solid var(--stroke); border-radius: 16px;
      padding: 0; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      color: var(--text); backdrop-filter: blur(16px); box-shadow: var(--shadow);
    }
    .modal-head{ padding: 18px 20px; border-bottom: 1px solid var(--stroke); display:flex; align-items:center; gap:10px;}
    .modal-body{ padding: 16px 20px; display: grid; gap: 12px;}
    .firm-list{ display:grid; gap:10px; }
    .firm-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke); border-radius: 12px; padding: 12px 14px; background: var(--glass);
    }
    .muted{ color: var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .error{
      border: 1px solid rgba(255,77,77,0.5);
      background: linear-gradient(180deg, rgba(255,77,77,0.18), rgba(255,77,77,0.06));
      color: #ffd9d9; padding: 10px 12px; border-radius: 12px;
    }

    a.clean { color: inherit; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>FocusPad</h1>
          <div class="sub">Tagesaufgaben ¬∑ √úbergaben ¬∑ Notizen</div>
        </div>
      </div>
      <div class="meta">
        <span class="pill"><span class="gold-dot"></span><span id="firm-label">Firma: ‚Äì</span></span>
        <span class="pill">Rolle: <span id="role-label" style="margin-left:6px; color:#fff;">‚Äì</span></span>
        <span class="pill">User: <span id="user-label" style="margin-left:6px; color:#fff;">‚Äì</span></span>
        <button id="switch-firm" class="btn">Firma wechseln</button>
        <button id="logout" class="btn gold">Logout</button>
      </div>
    </header>

    <!-- GRID -->
    <main class="grid">
      <!-- HERO / quick info -->
      <section class="hero">
        <article class="card">
          <div class="glow"></div>
          <div class="card-header">
            <h3 class="card-title">Dein Tag auf einen Blick</h3>
            <div class="row">
              <span class="pill">Status: aktiv</span>
              <span class="pill">Letzter Login: <span id="last-login" class="muted">‚Äì</span></span>
            </div>
          </div>
          <div style="padding: 14px 20px 20px 20px;">
            <p class="sub">Sammel alles Relevante des Tages an einem Ort: Aufgaben planen, saubere Schicht√ºbergaben sichern und schnelle Notizen festhalten.</p>
            <div style="margin-top:14px; display:flex; gap:10px; flex-wrap: wrap;">
              <button class="btn gold" id="to-notes">‚ûú Direkt zu Notizen</button>
              <button class="btn" id="to-tasks">‚ûú Zu Tagesaufgaben</button>
              <button class="btn" id="to-handover">‚ûú Zur Schicht√ºbergabe</button>
            </div>
          </div>
        </article>
        <aside class="card">
          <div class="glow"></div>
          <div class="card-header">
            <h3 class="card-title">Hinweise</h3>
          </div>
          <div style="padding: 14px 20px 20px 20px;">
            <ul class="sub" style="margin:0; padding-left:18px; display:grid; gap:8px;">
              <li>Nur Benutzer mit <b>status = accepted</b> in <code>firmen_user</code> haben Zugriff.</li>
              <li>Deine Firmenauswahl wird lokal gemerkt (<code>localStorage</code>).</li>
              <li>Design: Apple-Glass mit goldenen Akzenten (Rolex-Vibes).</li>
            </ul>
          </div>
        </aside>
      </section>

      <!-- APPS -->
      <section class="apps">
        <a class="clean tile" id="tile-notes" title="Notizen √∂ffnen">
          <div class="tile-body">
            <div>
              <h3>üìù Notizen</h3>
              <p>Schnelle Gedanken, Ideen, To-Dos ‚Äì alles mit Time-Stamp & Filter.</p>
              <span class="badge">Neu ¬∑ heute</span>
            </div>
            <div class="tile-icon">‚úçÔ∏è</div>
          </div>
        </a>

        <a class="clean tile" id="tile-tasks" title="Tagesaufgaben √∂ffnen">
          <div class="tile-body">
            <div>
              <h3>üìã Tagesaufgaben</h3>
              <p>Plane den Tag: Priorit√§ten, F√§lligkeiten, Verantwortliche.</p>
              <span class="badge">Priorit√§t ¬∑ Fokus</span>
            </div>
            <div class="tile-icon">‚úÖ</div>
          </div>
        </a>

        <a class="clean tile" id="tile-handover" title="Schicht√ºbergaben √∂ffnen">
          <div class="tile-body">
            <div>
              <h3>üîÅ Schicht√ºbergaben</h3>
              <p>Saubere √úbergaben: Was ist offen? Was wurde erledigt? N√§chste Schritte.</p>
              <span class="badge">Qualit√§t ¬∑ Klarheit</span>
            </div>
            <div class="tile-icon">üîÑ</div>
          </div>
        </a>
      </section>
    </main>
  </div>

  <!-- Firm-Chooser Modal -->
  <dialog id="firm-modal">
    <div class="modal-head">
      <h3 style="margin:0; font-weight:700;">Firma ausw√§hlen</h3>
    </div>
    <div class="modal-body">
      <p class="muted" id="firm-help">Wir haben mehrere Firmenzuordnungen gefunden. W√§hle aus, f√ºr welche Firma du FocusPad nutzen willst.</p>
      <div class="firm-list" id="firm-list"></div>
      <div id="no-firm" style="display:none" class="error">
        Kein Firmenzugang (status=accepted) gefunden. Bitte Admin einladen lassen oder Status pr√ºfen.
      </div>
      <div class="row" style="justify-content:flex-end; padding-top:6px;">
        <button class="btn" id="close-modal">Schlie√üen</button>
      </div>
    </div>
  </dialog>

  <!-- Supabase + Logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ===========================
    // üîß SUPABASE CONFIG (F√úLLEN)
    // ===========================
    const SUPABASE_URL = "https://lajqzmlhcsxhpfbhmlxe.supabase.co";     // <<-- EINTRAGEN
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhanF6bWxoY3N4aHBmYmhtbHhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzkzMTksImV4cCI6MjA3NTQxNTMxOX0.3fjdlh2Ozf0Ku7-s2459qYFCzQBBw49tzMFM-vFgmeg";                   // <<-- EINTRAGEN
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===========================
    // üß† STATE
    // ===========================
    const state = {
      session: null,
      user: null,
      firms: [],
      currentFirmaId: localStorage.getItem("Tenra.currentFirmaId") || null,
      currentRole: localStorage.getItem("Tenra.currentRole") || null,
    };

    const els = {
      firmLabel: document.getElementById("firm-label"),
      roleLabel: document.getElementById("role-label"),
      userLabel: document.getElementById("user-label"),
      lastLogin: document.getElementById("last-login"),
      logout: document.getElementById("logout"),
      switchFirm: document.getElementById("switch-firm"),
      modal: document.getElementById("firm-modal"),
      firmList: document.getElementById("firm-list"),
      firmHelp: document.getElementById("firm-help"),
      noFirm: document.getElementById("no-firm"),
      toNotes: document.getElementById("to-notes"),
      toTasks: document.getElementById("to-tasks"),
      toHandover: document.getElementById("to-handover"),
      tileNotes: document.getElementById("tile-notes"),
      tileTasks: document.getElementById("tile-tasks"),
      tileHandover: document.getElementById("tile-handover"),
      closeModal: document.getElementById("close-modal"),
    };

    // ===========================
    // üö™ AUTH / SESSION
    // ===========================
    async function ensureSession(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){
        // Kein Redirect erzwungen ‚Äì zeig kurzen Hinweis:
        els.userLabel.textContent = "Bitte einloggen";
        alert("Nicht eingeloggt. Bitte melde dich in Tenra an und lade die Seite neu.");
        return false;
      }
      state.session = session;
      state.user = session.user;
      els.userLabel.textContent = state.user.email || state.user.id;
      els.lastLogin.textContent = new Date(session.expires_at ? session.expires_at*1000 : Date.now()).toLocaleString();
      return true;
    }

    // ===========================
    // üè¢ FIRMEN & ROLLEN
    // ===========================
    async function loadFirms(){
      // 1) hole firmen_user rows f√ºr den User
      const { data: rows, error } = await supabase
        .from("firmen_user")
        .select("firma_id, role, status")
        .eq("user_id", state.user.id)
        .eq("status", "accepted");

      if(error){ console.error(error); return []; }
      if(!rows || rows.length === 0){ return []; }

      // 2) hole Firmennamen gesammelt
      const ids = [...new Set(rows.map(r => r.firma_id))];
      const { data: firms, error: err2 } = await supabase
        .from("firmen")
        .select("id, name")
        .in("id", ids);

      if(err2){ console.error(err2); return []; }

      // 3) join
      const byId = Object.fromEntries((firms||[]).map(f => [String(f.id), f.name]));
      const result = rows.map(r => ({
        firma_id: String(r.firma_id),
        role: r.role,
        name: byId[String(r.firma_id)] || `Firma ${r.firma_id}`
      }));

      state.firms = result;
      return result;
    }

    function setCurrentFirm(firma_id, role){
      state.currentFirmaId = String(firma_id);
      state.currentRole = role;
      localStorage.setItem("Tenra.currentFirmaId", state.currentFirmaId);
      localStorage.setItem("Tenra.currentRole", state.currentRole);
      renderFirmMeta();
    }

    function renderFirmMeta(){
      const f = state.firms.find(x => x.firma_id === state.currentFirmaId);
      els.firmLabel.textContent = "Firma: " + (f ? f.name : "‚Äì");
      els.roleLabel.textContent = state.currentRole ? state.currentRole : "‚Äì";
    }

    function openFirmChooser(){
      // bef√ºlle Liste
      els.firmList.innerHTML = "";
      if(!state.firms || state.firms.length === 0){
        els.noFirm.style.display = "block";
      } else {
        els.noFirm.style.display = "none";
        state.firms.forEach(f => {
          const row = document.createElement("div");
          row.className = "firm-item";
          row.innerHTML = `
            <div>
              <div style="font-weight:700">${f.name}</div>
              <div class="muted">Rolle: ${f.role} ¬∑ ID: ${f.firma_id}</div>
            </div>
            <button class="btn gold">Ausw√§hlen</button>
          `;
          row.querySelector("button").addEventListener("click", () => {
            setCurrentFirm(f.firma_id, f.role);
            els.modal.close();
          });
          els.firmList.appendChild(row);
        });
      }
      els.modal.showModal();
    }

    function go(path){
      if(!state.currentFirmaId){
        alert("Bitte zuerst eine Firma ausw√§hlen.");
        openFirmChooser();
        return;
      }
      // √úbergabe via localStorage (clean), optional Query:
      window.location.href = `${path}?firma=${encodeURIComponent(state.currentFirmaId)}`;
    }

    // ===========================
    // üé¨ INIT
    // ===========================
    (async () => {
      const ok = await ensureSession();
      if(!ok) return;

      const firms = await loadFirms();
      if(firms.length === 0){
        renderFirmMeta();
        openFirmChooser();
      } else {
        // Falls noch keine Firma gesetzt oder alte nicht mehr g√ºltig
        const stillValid = firms.some(f => f.firma_id === state.currentFirmaId);
        if(!state.currentFirmaId || !stillValid){
          // Auto-w√§hle erste Firma
          const f = firms[0];
          setCurrentFirm(f.firma_id, f.role);
          // zeig trotzdem Modal zur bewussten Auswahl
          openFirmChooser();
        } else {
          // setze Rolle passend zur gespeicherten Firma
          const f = firms.find(x => x.firma_id === state.currentFirmaId);
          if(f) state.currentRole = f.role;
          renderFirmMeta();
        }
      }
    })();

    // ===========================
    // üß≠ EVENTS
    // ===========================
    els.logout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      localStorage.removeItem("Tenra.currentFirmaId");
      localStorage.removeItem("Tenra.currentRole");
      window.location.reload();
    });

    els.switchFirm.addEventListener("click", openFirmChooser);
    els.closeModal.addEventListener("click", () => els.modal.close());

    // Quick actions + Tiles
    const linkTargets = {
      notes: "notizen.html",
      tasks: "aufgaben.html",
      handover: "uebergabe.html"
    };
    els.toNotes.addEventListener("click", () => go(linkTargets.notes));
    els.toTasks.addEventListener("click", () => go(linkTargets.tasks));
    els.toHandover.addEventListener("click", () => go(linkTargets.handover));

    document.getElementById("tile-notes").addEventListener("click", () => go(linkTargets.notes));
    document.getElementById("tile-tasks").addEventListener("click", () => go(linkTargets.tasks));
    document.getElementById("tile-handover").addEventListener("click", () => go(linkTargets.handover));
  </script>
</body>
</html>
