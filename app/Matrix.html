<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tenra ‚Äì Matrix-Module (Next)</title>

  <!-- SheetJS f√ºr Excel-Parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>

@media (max-width: 768px) {

  body {
    padding: 8px;
  }

  /* Layout auf 1 Spalte */
  .layout {
    grid-template-columns: 1fr !important;
    gap: 10px;
  }

  /* Sidebar zuerst | Hauptbereich danach */
  .panel {
    padding: 10px !important;
  }

  /* Module-Liste kompakter */
  .module-list {
    max-height: 40vh !important;
  }

  /* Module kleiner */
  .module-item {
    padding: 6px 8px !important;
    font-size: 13px !important;
  }
  .module-item span.meta {
    font-size: 10px !important;
  }

  /* Header kleiner */
  .top-bar h1 {
    font-size: 20px !important;
  }

  .top-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  /* Toolbar umbricht auf mehrere Reihen */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  /* Buttons kompakt */
  button,
  button.small,
  button.icon {
    padding: 6px 10px !important;
    font-size: 12px !important;
  }

  /* Tabelle ‚Äî horizontales Scrollen erm√∂glichen */
  .grid-wrapper {
    max-height: 52vh !important;
    overflow-x: auto !important;
  }

  table.sheet {
    min-width: 600px !important;
  }

  /* Dropdowns breiter */
  .dropdown {
    padding: 10px 12px !important;
    font-size: 13px !important;
  }

  /* Tutorial-Karten kleiner */
  .tutorial-card {
    padding: 10px !important;
    font-size: 12px !important;
  }
  .tutorial-card-title {
    font-size: 13px !important;
  }
}

@media (max-width: 768px) {
  .grid-top-bar {
    position: sticky;
    top: 0;
    z-index: 50;
  }
}

@media (max-width: 768px) {
  td.excel-cell {
    max-width: 80px !important;
    font-size: 12px !important;
    padding: 3px !important;
  }

  table.sheet th,
  table.sheet td {
    padding: 3px 4px !important;
    font-size: 11px !important;
  }
}

@media (max-width: 768px) {
  #tutorialContainer {
    gap: 12px !important;
  }
  .tutorial-cards-row {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
  }
}

/* =========================
   TENRA ACADEMY / TUTORIAL
   ========================= */

#tutorialContainer {
  padding: 12px 4px 4px 4px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  animation: fadeIn 0.25s ease;
}

.tutorial-header-text {
  font-size: 13px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.tutorial-cards-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 10px;
}

.tutorial-card {
  padding: 12px 14px;
  border-radius: 14px;
  cursor: pointer;
  font-size: 13px;
  line-height: 1.35;
  transition: 0.18s ease;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

html[data-theme="dark"] .tutorial-card {
  backdrop-filter: blur(18px) saturate(160%);
  background: rgba(15,23,42,0.92);
  border: 1px solid rgba(148,163,184,0.45);
  box-shadow: 0 10px 26px rgba(15,23,42,0.6);
  color: var(--text-dark);
}
html[data-theme="light"] .tutorial-card {
  backdrop-filter: blur(16px) saturate(150%);
  background: rgba(255,255,255,0.94);
  border: 1px solid rgba(148,163,184,0.4);
  box-shadow: 0 10px 24px rgba(15,23,42,0.14);
  color: var(--text-light);
}

.tutorial-card-title {
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.tutorial-card-sub {
  font-size: 11px;
  opacity: 0.8;
}

.tutorial-card:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: 0 14px 30px rgba(15,23,42,0.8);
  border-color: var(--accent);
}
.tutorial-card.active {
  border-color: var(--accent);
  box-shadow: 0 16px 36px rgba(22,163,74,0.55);
}

/* Suchfeld im Tutorial */
#tutorialSearch {
  width: 100%;
  padding: 9px 12px;
  border-radius: 12px;
  font-size: 13px;
  outline: none;
  border: 1px solid rgba(148,163,184,0.55);
  margin-bottom: 4px;
}

html[data-theme="dark"] #tutorialSearch {
  background: rgba(15,23,42,0.95);
  color: var(--text-dark);
  box-shadow: 0 10px 26px rgba(15,23,42,0.7);
}
html[data-theme="light"] #tutorialSearch {
  background: rgba(255,255,255,0.96);
  color: var(--text-light);
  box-shadow: 0 10px 24px rgba(15,23,42,0.16);
}

#tutorialSearch::placeholder {
  opacity: 0.7;
}

/* Content-Bereich rechts unter den Cards */
.tutorial-content {
  margin-top: 6px;
  border-radius: 14px;
  padding: 12px 14px;
  font-size: 13px;
}

html[data-theme="dark"] .tutorial-content {
  background: rgba(15,23,42,0.96);
  border: 1px solid rgba(148,163,184,0.6);
}
html[data-theme="light"] .tutorial-content {
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(148,163,184,0.5);
}

.tutorial-section {
  margin-bottom: 10px;
}
.tutorial-section h3 {
  margin: 0 0 4px;
  font-size: 14px;
}
.tutorial-section p {
  margin: 0 0 4px;
  font-size: 13px;
}
.tutorial-section ul {
  margin: 0 0 4px 18px;
  padding: 0;
  font-size: 13px;
}
.tutorial-section li {
  margin-bottom: 3px;
}

/* kleine Info-Chips im Tutorial */
.tutorial-chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 4px;
}
.tutorial-chip {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.7);
}
html[data-theme="dark"] .tutorial-chip {
  background: rgba(15,23,42,0.9);
}
html[data-theme="light"] .tutorial-chip {
  background: rgba(255,255,255,0.95);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}



    /* Sidebar scrollbar unsichtbar machen */
.panel {
  scrollbar-width: none;        /* Firefox */
  -ms-overflow-style: none;     /* IE / Edge */
}

.panel::-webkit-scrollbar {
  display: none;                /* Chrome, Safari */
}


    /* --- FULLSCREEN ANIMATIONEN (APPLE STYLE) --- */

    /* Scrollbar in der Modulliste unsichtbar machen */
.module-list {
  scrollbar-width: none;        /* Firefox */
  -ms-overflow-style: none;     /* IE / Edge */
}

.module-list::-webkit-scrollbar {
  display: none;                /* Chrome, Safari */
}


body.is-fullscreen .layout {
  grid-template-columns: 0px 1fr !important;
  transition: grid-template-columns 0.35s cubic-bezier(0.22,1,0.36,1);
}

body.is-fullscreen .panel:first-child {
  opacity: 0;
  transform: translateX(-30px);
  pointer-events: none;
  transition:
    opacity 0.25s ease,
    transform 0.35s cubic-bezier(0.22,1,0.36,1);
}

body.is-fullscreen .grid-shell {
  border-radius: 0px !important;
  border: none !important;
  box-shadow: none !important;
  animation: gridExpand 0.35s cubic-bezier(0.22,1,0.36,1);
}

@keyframes gridExpand {
  from { transform: scale(0.97) translateY(10px); opacity: 0.4; }
  to   { transform: scale(1)      translateY(0);    opacity: 1; }
}

/* FLOATING TOOLBAR */
body.is-fullscreen .grid-top-bar {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 120px);
  max-width: 1400px;
  border-radius: 14px;
  padding: 8px 14px;
  backdrop-filter: blur(18px) saturate(150%);
  z-index: 9999;

  transition:
    width 0.25s ease,
    top 0.25s ease,
    opacity 0.25s ease,
    background 0.25s ease;
}

body.is-fullscreen .grid-wrapper {
  max-height: calc(100vh - 90px) !important;
  margin-top: 65px;
}

    html[data-theme="light"] .dropdown-menu {
  background: rgba(255,255,255,0.89);
  border: 1px solid rgba(15,23,42,0.15);
  backdrop-filter: blur(14px) saturate(140%);
}

html[data-theme="light"] .dropdown {
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(0,0,0,0.12);
  color: #0b1120;
}

html[data-theme="light"] .dropdown-item:hover {
  background: rgba(12,123,72,0.15); /* soft green highlight */
}

html[data-theme="light"] .dropdown-selected {
  color: #0b1120;
}

html[data-theme="light"] .dropdown-arrow {
  color: #0b1120;
}



#moduleSearch {
  position: relative;
  z-index: 100000;
}




.dropdown.closing .dropdown-menu {
  max-height: 0 !important;
  opacity: 0 !important;
  transform: translateY(-4px) scale(0.98) !important;
}
    .dropdown.open {
  transform: translateY(0) scale(1.015);
  transition: transform 0.22s cubic-bezier(0.22, 1, 0.36, 1);
}
   .dropdown {
  position: relative;
  width: 100%;
  padding: 12px 14px;
  border-radius: 14px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;

  background: rgba(255,255,255,0.14);
  border: 1px solid rgba(255,255,255,0.3);
  backdrop-filter: blur(16px) saturate(180%);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);

  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: 0.2s ease;
}

.dropdown:hover {
  border-color: var(--accent);
  box-shadow: 0 8px 24px rgba(0,0,0,0.35);
}

.dropdown-arrow {
  transition: transform 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}


.dropdown.open .dropdown-arrow {
  transform: rotate(180deg);
}

.dropdown-menu {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  right: 0;

   background: rgba(15,23,42,0.89); /* fast komplett undurchsichtig */
  border: 1px solid rgba(255,255,255,0.2);
   backdrop-filter: blur(12px) saturate(160%);
  border-radius: 12px;

  max-height: 0;
  opacity: 0;
  overflow: hidden;
  transform: translateY(-6px) scale(0.98);
  pointer-events: none;

  transition:
    max-height 0.28s cubic-bezier(0.22, 1, 0.36, 1),
    opacity 0.22s ease,
    transform 0.28s cubic-bezier(0.22, 1, 0.36, 1);

  z-index: 9999;
}

.dropdown.open .dropdown-menu {
  max-height: 260px;
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}


.dropdown-item {
  padding: 10px 14px;
  cursor: pointer;
  transition: 0.15s ease;
  font-size: 13px;
}

.dropdown-item:hover {
  background: rgba(34,197,94,0.18);
}


.sel {
  width: 100%;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  appearance: none;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(148,163,184,0.4);
  color: var(--text-dark);
  backdrop-filter: blur(6px);
  transition: all 0.2s ease;
  background-image: url("data:image/svg+xml;utf8,<svg fill='%23a0a8b2' height='20' width='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'><polygon points='5,7 15,7 10,12'/></svg>");
  background-repeat: no-repeat;
  background-position: calc(100% - 10px) center;
}
.sel:hover {
  border-color: var(--accent);
}
html[data-theme="light"] .sel {
  background: rgba(255,255,255,0.9);
  color: var(--text-light);
}


    :root {
      --bg-dark: #05070b;
      --panel-dark: rgba(255,255,255,0.03);
      --panel-border-dark: rgba(255,255,255,0.08);
      --text-dark: #f5f7fb;
      --muted-dark: #a0a8b2;

      --bg-light: #f5f7fb;
      --panel-light: #ffffff;
      --panel-border-light: rgba(15,23,42,0.08);
      --text-light: #0b1120;
      --muted-light: #64748b;

      --accent: #0c7b48;
      --accent-soft: rgba(12,123,72,0.18);
      --danger: #c0392b;
      --danger-hover: #e74c3c;
      --shadow-dark: 0 18px 45px rgba(0,0,0,0.55);
      --shadow-light: 0 18px 45px rgba(15,23,42,0.11);

      --cell-border: rgba(148,163,184,0.28);
      --cell-border-light: rgba(148,163,184,0.35);

      --header-bg-dark: #050816;
      --header-bg-light: #e5e7eb;

      --comment-bg: rgba(15,23,42,0.95);
      --comment-text: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    html[data-theme="dark"] body {
      background: radial-gradient(circle at top, #151b2e 0, #05070b 40%, #020308 100%);
      color: var(--text-dark);
    }
    html[data-theme="light"] body {
      background: radial-gradient(circle at top, #dbeafe 0, #f3f4f6 40%, #e5e7eb 100%);
      color: var(--text-light);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      margin: 0;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 20px;
      margin: 0 0 6px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      gap: 12px;
    }

    .status {
      font-size: 13px;
    }
    html[data-theme="dark"] .status { color: var(--muted-dark); }
    html[data-theme="light"] .status { color: var(--muted-light); }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      border-radius: 14px;
      padding: 12px;
      backdrop-filter: blur(18px) saturate(135%);
      transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }

    html[data-theme="dark"] .panel {
      background: var(--panel-dark);
      border: 1px solid var(--panel-border-dark);
      box-shadow: var(--shadow-dark);
    }
    html[data-theme="light"] .panel {
      background: var(--panel-light);
      border: 1px solid var(--panel-border-light);
      box-shadow: var(--shadow-light);
    }

    button {
      padding: 8px 14px;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 999px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
      box-shadow: 0 8px 18px rgba(34,197,94,0.2);
      white-space: nowrap;
    }
    button:hover {
      background: #089d57;
      transform: translateY(-0.5px);
      box-shadow: 0 10px 22px rgba(34,197,94,0.27);
    }
    button:active {
      transform: translateY(0.5px) scale(0.99);
      box-shadow: 0 5px 12px rgba(34,197,94,0.18);
    }
    button.small {
      padding: 4px 10px;
      font-size: 12px;
      box-shadow: none;
    }
    button.icon {
      padding: 6px 8px;
      border-radius: 11px;
      font-size: 12px;
    }
    button.danger {
      background: var(--danger);
      box-shadow: 0 8px 18px rgba(220,38,38,0.28);
    }
    button.danger:hover {
      background: var(--danger-hover);
      box-shadow: 0 10px 22px rgba(220,38,38,0.32);
    }
    button.ghost {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.5);
      color: inherit;
      box-shadow: none;
    }
    button.ghost:hover {
      background: rgba(148,163,184,0.08);
    }
    button.toggle-on {
      background: rgba(22,163,74,0.09);
      color: #22c55e;
      border: 1px solid rgba(34,197,94,0.65);
      box-shadow: 0 8px 18px rgba(22,163,74,0.32);
    }

    .upload-area {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .info-line {
      font-size: 13px;
      margin-bottom: 6px;
    }
    html[data-theme="dark"] .info-line { color: var(--muted-dark); }
    html[data-theme="light"] .info-line { color: var(--muted-light); }

    .module-list {
      margin-top: 6px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .module-item {
      padding: 8px 10px;
      border-radius: 11px;
      margin-bottom: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition: 0.15s all;
    }
    html[data-theme="dark"] .module-item {
      background: rgba(15,23,42,0.75);
    }
    html[data-theme="light"] .module-item {
      background: rgba(255,255,255,0.9);
    }
    .module-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(15,23,42,0.25);
    }
    .module-item.active {
      border-color: var(--accent);
      box-shadow: 0 14px 34px rgba(34,197,94,0.28);
      position: relative;
    }
    .module-item span.name {
      font-weight: 600;
      display: block;
    }
    html[data-theme="dark"] .module-item span.name { color: var(--text-dark); }
    html[data-theme="light"] .module-item span.name { color: var(--text-light); }

    .module-item span.meta {
      font-size: 11px;
    }
    html[data-theme="dark"] .module-item span.meta { color: var(--muted-dark); }
    html[data-theme="light"] .module-item span.meta { color: var(--muted-light); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(12,123,72,0.16);
      color: #4ade80;
      font-size: 10px;
      margin-top: 4px;
    }

    .muted {
      font-size: 13px;
    }
    html[data-theme="dark"] .muted { color: var(--muted-dark); }
    html[data-theme="light"] .muted { color: var(--muted-light); }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .toolbar {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .toolbar span.hint {
      font-size: 11px;
    }
    html[data-theme="dark"] .toolbar span.hint { color: var(--muted-dark); }
    html[data-theme="light"] .toolbar span.hint { color: var(--muted-light); }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148,163,184,0.5);
    }
    html[data-theme="dark"] .pill {
      background: rgba(15,23,42,0.85);
      color: var(--muted-dark);
    }
    html[data-theme="light"] .pill {
      background: rgba(255,255,255,0.9);
      color: var(--muted-light);
    }

    .formula-bar-wrapper {
      margin: 6px 0 8px;
      position: relative;
    }

    #formulaBar {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 13px;
      outline: none;
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
    }
    html[data-theme="light"] #formulaBar {
      background: rgba(255,255,255,0.92);
      color: #0f172a;
    }
    #formulaBar::placeholder {
      color: #6b7280;
    }

    .formula-helper {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      opacity: 0.7;
      pointer-events: none;
    }

    .formula-suggestions {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 4px;
      border-radius: 8px;
      overflow: hidden;
      max-height: 220px;
      overflow-y: auto;
      z-index: 20;
    }
    html[data-theme="dark"] .formula-suggestions {
      background: rgba(15,23,42,0.98);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 16px 40px rgba(15,23,42,0.75);
    }
    html[data-theme="light"] .formula-suggestions {
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 16px 40px rgba(15,23,42,0.13);
    }

    .formula-suggestion {
      padding: 6px 10px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .formula-suggestion span.name {
      font-weight: 600;
    }
    .formula-suggestion span.desc {
      font-size: 11px;
      opacity: 0.7;
    }
    .formula-suggestion:hover {
      background: rgba(34,197,94,0.12);
    }

    .grid-shell {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.5);
    }
    html[data-theme="dark"] .grid-shell {
      background: rgba(15,23,42,0.94);
    }
    html[data-theme="light"] .grid-shell {
      background: rgba(255,255,255,0.98);
    }

    .grid-top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      padding: 4px 8px;
      border-bottom: 1px solid rgba(148,163,184,0.45);
    }
    html[data-theme="dark"] .grid-top-bar {
      background: rgba(15,23,42,0.98);
      color: var(--muted-dark);
    }
    html[data-theme="light"] .grid-top-bar {
      background: rgba(241,245,249,0.95);
      color: var(--muted-light);
    }

    .sheet-tabs {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .sheet-tab {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    html[data-theme="dark"] .sheet-tab {
      color: var(--muted-dark);
    }
    html[data-theme="light"] .sheet-tab {
      color: var(--muted-light);
    }
    .sheet-tab.active {
      border-color: var(--accent);
      background: rgba(34,197,94,0.16);
      color: #22c55e;
    }

    .zoom-indicator {
      font-size: 11px;
    }

    .grid-wrapper {
      overflow: auto;
      max-height: 60vh;
      position: relative;
      transform-origin: top left;
    }

    table.sheet {
      border-collapse: collapse;
      min-width: 780px;
      font-size: 13px;
      table-layout: fixed;
    }

    table.sheet th,
    table.sheet td {
      padding: 4px 6px;
      border-bottom: 1px solid;
      border-right: 1px solid;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    /* MAXIMALE ZELLBREITE (ca. 5cm) */
table.sheet td.excel-cell {
  max-width: 100px;       /* ~5 cm */
  width: 100;           /* erzwingt Konsistenz */
  min-width: 30px;        /* Standardbreite */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

    html[data-theme="dark"] table.sheet th,
    html[data-theme="dark"] table.sheet td {
      border-color: var(--cell-border);
    }
    html[data-theme="light"] table.sheet th,
    html[data-theme="light"] table.sheet td {
      border-color: var(--cell-border-light);
    }

    table.sheet th {
      position: sticky;
      top: 0;
      z-index: 3;
      font-weight: 600;
      font-size: 11px;
    }
    html[data-theme="dark"] table.sheet th {
      background: var(--header-bg-dark);
      color: var(--muted-dark);
    }
    html[data-theme="light"] table.sheet th {
      background: var(--header-bg-light);
      color: var(--muted-light);
    }

    table.sheet th.row-header {
      left: 0;
      z-index: 4;
      text-align: right;
      width: 40px;
      min-width: 40px;
      max-width: 40px;
      user-select: none;
    }
    table.sheet td.row-header {
      position: sticky;
      left: 0;
      z-index: 2;
      text-align: right;
      width: 40px;
      min-width: 40px;
      max-width: 40px;
      font-size: 11px;
      user-select: none;
    }
    html[data-theme="dark"] table.sheet td.row-header {
      background: #020617;
      color: var(--muted-dark);
    }
    html[data-theme="light"] table.sheet td.row-header {
      background: #f3f4f6;
      color: var(--muted-light);
    }

    td.excel-cell {
      cursor: cell;
      background: transparent;
      transition: background 0.05s ease, outline 0.05s ease;
    }

    td.excel-cell.selected {
      outline: 2px solid var(--accent);
      outline-offset: -1px;
      background: rgba(34,197,94,0.12);
    }

    td.excel-cell.in-range {
      background: rgba(34,197,94,0.08);
    }

    td.excel-cell:hover {
      background: rgba(148,163,184,0.18);
    }

    td.excel-cell.negative {
      background: rgba(239,68,68,0.08);
      color: #fee2e2;
    }
    html[data-theme="light"] td.excel-cell.negative {
      color: #b91c1c;
    }

    td.excel-cell.positive {
      background: rgba(34,197,94,0.06);
      color: #bbf7d0;
    }
    html[data-theme="light"] td.excel-cell.positive {
      color: #166534;
    }

    td.excel-cell.zero {
      opacity: 0.85;
    }

    td.excel-cell.error-cell {
      background: rgba(239,68,68,0.16);
      color: #fecaca;
      font-weight: 600;
    }
    html[data-theme="light"] td.excel-cell.error-cell {
      background: rgba(248,113,113,0.16);
      color: #b91c1c;
    }

    .cell-comment-indicator {
      position: absolute;
      right: 0;
      top: 0;
      width: 0;
      height: 0;
      border-top: 7px solid #facc15;
      border-left: 7px solid transparent;
      z-index: 5;
    }

    .comment-tooltip {
      position: absolute;
      max-width: 260px;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 8px;
      pointer-events: none;
      z-index: 50;
      white-space: normal;
    }
    html[data-theme="dark"] .comment-tooltip {
      background: var(--comment-bg);
      color: var(--comment-text);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
    }
    html[data-theme="light"] .comment-tooltip {
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 18px 40px rgba(15,23,42,0.42);
      border: 1px solid rgba(55,65,81,0.85);
    }

    .col-resize-handle {
      position: absolute;
      top: 0;
      right: -3px;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
    }

    .context-menu {
      position: fixed;
      z-index: 999;
      min-width: 170px;
      border-radius: 10px;
      overflow: hidden;
      font-size: 12px;
    }
    html[data-theme="dark"] .context-menu {
      background: rgba(15,23,42,0.98);
      color: var(--text-dark);
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 22px 50px rgba(15,23,42,0.96);
    }
    html[data-theme="light"] .context-menu {
      background: #ffffff;
      color: var(--text-light);
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 22px 50px rgba(15,23,42,0.24);
    }

    .context-menu-item {
      padding: 7px 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .context-menu-item span.shortcut {
      opacity: 0.7;
      font-size: 11px;
    }
    .context-menu-item:hover {
      background: rgba(34,197,94,0.16);
    }

    .search-replace-panel {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 11px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    html[data-theme="dark"] .search-replace-panel {
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.7);
    }
    html[data-theme="light"] .search-replace-panel {
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(148,163,184,0.7);
    }
    .search-replace-panel input {
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.7);
      min-width: 160px;
      outline: none;
      background: transparent;
    }
    .search-replace-panel label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .error-banner {
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 11px;
      display: none;
    }
    html[data-theme="dark"] .error-banner {
      background: rgba(127,29,29,0.9);
      color: #fee2e2;
      border: 1px solid rgba(254,202,202,0.85);
    }
    html[data-theme="light"] .error-banner {
      background: rgba(254,202,202,0.9);
      color: #7f1d1d;
      border: 1px solid rgba(185,28,28,0.85);
    }

    .kbd {
      border-radius: 4px;
      padding: 1px 4px;
      border: 1px solid rgba(148,163,184,0.8);
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.7);
    }
    html[data-theme="dark"] .chip {
      background: rgba(15,23,42,0.96);
      color: var(--muted-dark);
    }
    html[data-theme="light"] .chip {
      background: rgba(255,255,255,0.96);
      color: var(--muted-light);
    }
    .module-item.locked {
  border-left: 3px solid var(--gold);
}


.dept-btn {
  margin-left: auto;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--muted-dark);
  font-size: 14px;
}
.dept-btn:hover {
  color: var(--accent);
}
body.is-fullscreen {
  overflow: hidden;
}
@media (max-width: 768px) {

  /* Button sichtbar machen */
  #toggleSidebar {
    display: block !important;
    width: 100%;
    margin-bottom: 10px;
    padding: 10px 14px;
    font-size: 14px;
  }

  /* Sidebar standardm√§√üig verstecken */
  .panel:first-child {
    display: none !important;
  }

  /* Wenn aktiv ‚Üí anzeigen */
  .panel.show-sidebar:first-child {
    display: block !important;
  }

}

  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>üì¶ Tenra Matrix-Module</h1>
      <div class="status" id="statusUser">Lade Benutzer‚Ä¶</div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;">
      <button id="themeToggleBtn" class="small ghost icon" type="button">üåì Theme</button>
      <button onclick="window.location.href='/app/dashboard.html'" class="small" type="button">‚Üê Zur √úbersicht</button>
    </div>
  </div>
<button id="toggleSidebar" class="small ghost icon" style="display:none;">
  üìÅ Module
</button>

  <div class="layout">
    <!-- SIDEBAR -->
    <div class="panel">
      <div class="upload-area">
        <button id="uploadBtn" type="button">‚ûï Tabellendatei / CSV importieren</button>
        <button id="newEmptyModuleBtn" class="ghost small" type="button">+ Leeres Modul</button>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
      

 <div class="info-line"><strong>Module dieser Firma</strong></div>

      <input id="moduleSearch"
       placeholder="Module suchen‚Ä¶"
       style="
         width:100%;
         padding:8px 12px;
         margin:8px 0;
         border-radius:10px;
         border:1px solid rgba(148,163,184,0.35);
         background:rgba(255,255,255,0.07);
         backdrop-filter:blur(6px);
         font-size:13px;
       ">
<div class="info-line"><strong>Abteilung</strong></div>
<div id="deptDropdown" class="dropdown">
  <div class="dropdown-selected">‚Äì Abteilung w√§hlen ‚Äì</div>
  <div class="dropdown-arrow">‚ñº</div>
  <div class="dropdown-menu" id="deptMenu"></div>
</div>





<div class="sep"></div>

     

      <div id="moduleList" class="module-list">Lade Module‚Ä¶</div>
    </div>

    <!-- MAIN -->
        <div class="panel">
      <!-- Wrapper f√ºr "kein Modul ausgew√§hlt" -->
      <div id="noModuleSelected">
        <div id="tutorialContainer" style="display:flex;flex-direction:column;gap:22px;">
          <!-- Tenra Academy wird hier per JS gerendert -->
        </div>

        <p class="muted">
          Kein Modul ausgew√§hlt. W√§hle links ein Modul oder lade eine Excel-Datei hoch.<br>
          Spalten, Formeln, Prozentangaben und Layout werden intelligent √ºbernommen.
        </p>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:6px;">
          <div class="pill">
            <span>Formelbeispiele:</span>
            <code>=A1+B1</code>,
            <code>=F7/(100%+D7)</code>,
            <code>=A1*25%</code>,
            <code>=G7/(1+12%)</code>,
            <code>=SUM(A1:A10)</code>,
            <code>=AVERAGE(B1:B5)</code>,
            <code>=MIN()</code>,
            <code>=MAX()</code>,
            <code>=ROUND()</code>,
            <code>=ABS()</code>
          </div>
          <div class="pill">
            <span class="kbd">Strg</span>+<span class="kbd">C</span>,
            <span class="kbd">V</span>,
            <span class="kbd">Z</span>,
            <span class="kbd">Y</span> ‚Ä¢ Doppelklick = Direktbearbeitung ‚Ä¢ Rechtsklick = Zellmen√º
          </div>
        </div>
      </div>

      <div id="moduleDetail" style="display:none;">

        <div class="main-header">
          <div>
            <h2 id="moduleTitle">Modul</h2>
            <div class="info-line" id="moduleMeta"></div>
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button id="exportXlsxBtn" class="ghost small icon" type="button">‚¨á XLSX</button>
            <button id="exportCsvBtn" class="ghost small icon" type="button">‚¨á CSV</button>
            <button id="deleteModuleBtn" class="danger small" type="button">Modul l√∂schen</button>
          </div>
        </div>

        <div class="error-banner" id="errorBanner"></div>

        <div class="toolbar">
          <button id="addRowBtn" class="small ghost icon" type="button">+ Zeile</button>
          <button id="addColBtn" class="small ghost icon" type="button">+ Spalte</button>
          <button id="undoBtn" class="small ghost icon" type="button">‚Ü∂ Undo</button>
          <button id="redoBtn" class="small ghost icon" type="button">‚Ü∑ Redo</button>
          <button id="freezeToggleBtn" class="small ghost icon" type="button">üìå Freeze</button>
          <button id="filterToggleBtn" class="small ghost icon" type="button">‚è∑ Filter</button>
          <button id="lockToggleBtn" class="small ghost icon" type="button" style="display:none;">
  üîí Schreibschutz
</button>

          <button id="create-under-btn" class="small" style="display:none;margin-left:auto;">
  Untermodul erstellen
</button>
          <span class="hint">Tipp: Formeln beginnen mit <code>=</code> ‚Äì Prozentwerte als <code>25%</code>, <code>0.25</code> oder <code>25</code> in Kombination mit <code>%</code>.</span>
        </div>

        <div class="formula-bar-wrapper">
          <span class="formula-helper">fx</span>
          <input id="formulaBar" placeholder="Wert oder =Formel eingeben (z. B. =F7/(100%+D7))">
          <div id="formulaSuggestions" class="formula-suggestions" style="display:none;"></div>
        </div>

        <div class="search-replace-panel" id="searchPanel">
          <label>
            Suchen:
            <input type="text" id="searchInput">
          </label>
          <label>
            Ersetzen:
            <input type="text" id="replaceInput">
          </label>
          <button id="searchNextBtn" class="small ghost icon" type="button">Suchen</button>
          <button id="replaceOneBtn" class="small ghost icon" type="button">Ersetzen</button>
          <button id="replaceAllBtn" class="small ghost icon" type="button">Alle ersetzen</button>
          <span class="chip">
            üîç <span id="searchStatus">0 Treffer</span>
          </span>
        </div>

        <div id="tableContainer">
          <div class="muted">Lade Daten‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://lajqzmlhcsxhpfbhmlxe.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhanF6bWxoY3N4aHBmYmhtbHhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzkzMTksImV4cCI6MjA3NTQxNTMxOX0.3fjdlh2Ozf0Ku7-s2459qYFCzQBBw49tzMFM-vFgmeg";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const XLSX = window.XLSX;

    const state = {
      
      user: null,
      session: null,
      firma_id: null,
      role: null,

      modules: [],
      currentModule: null,
      currentFile: null,

      currentDeptFilter: "",
currentLineFilter: "",


      sheetName: "Sheet1",
      sheets: ["Sheet1"],

      grid: {},           // key: "row:col:sheet" ‚Üí { value, formula }
      maxRow: 40,
      maxColIndex: 15,

      selectedCell: null, // { row, colLabel, sheetName }
      selectionRange: null, // { startRow, endRow, startColIndex, endColIndex, sheetName }

      zoom: 1,
      darkMode: true,
      freezeFirstRowCol: true,
      filterEnabled: false,
      filters: {},

      undoStack: [],
      redoStack: [],
      clipboard: null,    // { cells: [ [ {value,formula}, ... ] ], rows, cols }
      lastSearchResults: [],
      lastSearchIndex: -1,

      comments: {},       // key: row:col:sheet ‚Üí text
    };

    const statusUserEl   = document.getElementById("statusUser");
    const moduleListEl   = document.getElementById("moduleList");
    const noModuleEl     = document.getElementById("noModuleSelected");
    const moduleDetailEl = document.getElementById("moduleDetail");
    const moduleTitleEl  = document.getElementById("moduleTitle");
    const moduleMetaEl   = document.getElementById("moduleMeta");
    const tableContainer = document.getElementById("tableContainer");
    const uploadBtn      = document.getElementById("uploadBtn");
    const excelInput     = document.getElementById("excelInput");
    const newEmptyModuleBtn = document.getElementById("newEmptyModuleBtn");
    const deleteModuleBtn= document.getElementById("deleteModuleBtn");
    const exportXlsxBtn  = document.getElementById("exportXlsxBtn");
    const exportCsvBtn   = document.getElementById("exportCsvBtn");

    const formulaBarEl   = document.getElementById("formulaBar");
    const formulaSuggestionsEl = document.getElementById("formulaSuggestions");
    const addRowBtn      = document.getElementById("addRowBtn");
    const addColBtn      = document.getElementById("addColBtn");
    const undoBtn        = document.getElementById("undoBtn");
    const redoBtn        = document.getElementById("redoBtn");
    const freezeToggleBtn= document.getElementById("freezeToggleBtn");
    const filterToggleBtn= document.getElementById("filterToggleBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const errorBannerEl  = document.getElementById("errorBanner");

    const searchInput    = document.getElementById("searchInput");
    const replaceInput   = document.getElementById("replaceInput");
    const searchNextBtn  = document.getElementById("searchNextBtn");
    const replaceOneBtn  = document.getElementById("replaceOneBtn");
    const replaceAllBtn  = document.getElementById("replaceAllBtn");
    const searchStatusEl = document.getElementById("searchStatus");

    const matrixAbtEl = document.getElementById("matrix-abteilung");


// ===============================
// TENRA ACADEMY ‚Äì Tutorial System
// ===============================

const tutorialTopics = {
  basics: {
    title: "üìà Grundlagen ‚Äì So funktioniert Tenra Matrix",
    subtitle: "Modul ausw√§hlen, arbeiten, speichern ‚Äì ohne Angst vor Excel-Chaos.",
    keywords: ["grundlagen","start","einf√ºhrung","erste schritte","modul"],
    sections: [
      {
        heading: "Was ist ein Modul?",
        items: [
          "Ein Modul = eine Tabelle f√ºr ein Thema (z. B. Schichtplan, Stillst√§nde, Controlling).",
          "Links in der Liste siehst du alle Module deiner Firma ‚Äì gefiltert nach Abteilung.",
          "Hauptmodule sind die ‚ÄûMaster-Vorlagen‚Äú, Untermodule sind Kopien davon f√ºr Varianten."
        ]
      },
      {
        heading: "Wie du startest",
        items: [
          "Links: ‚ùå keine Module? ‚Üí Erstelle ein leeres Modul oder importiere eine Excel-Datei.",
          "Links: ‚úÖ schon Module? ‚Üí Klick auf ein Modul, rechts √∂ffnet sich die Matrix.",
          "Doppelklick auf eine Zelle = direkt bearbeiten, wie in Excel."
        ]
      }
    ]
  },
  formulas: {
    title: "üî¢ Formeln, Prozent & Logik",
    subtitle: "Genau wie in klassichen Tabellendateien ‚Äì nur robuster und logischer bei Prozenten.",
    keywords: ["formel","prozente","%","berechnung","summe"],
    sections: [
      {
        heading: "Formeln eingeben",
        items: [
          "Formeln starten immer mit =, z. B. =A1+B1 oder =SUM(A1:A10).",
          "Prozent kannst du als 25%, 0.25 oder 25 mit % in der Formel nutzen.",
          "Beispiel: =F7/(100%+D7) ‚Üí 100% wird automatisch als 1.0 interpretiert."
        ]
      },
      {
        heading: "Wichtige Funktionen",
        items: [
          "SUM(A1:A10) ‚Äì Summe eines Bereichs.",
          "AVERAGE(B1:B5) ‚Äì Durchschnitt.",
          "MIN(), MAX() ‚Äì kleinster / gr√∂√üter Wert.",
          "ROUND(D1;2) ‚Äì Rundet auf 2 Nachkommastellen.",
          "ABS(E1) ‚Äì Absolutwert (Entfernt Minus)."
        ]
      },
      {
        heading: "Fehler verstehen",
        items: [
          "#DIV/0! ‚Äì durch 0 geteilt.",
          "#NAME? ‚Äì unbekannte Funktion / Bezug.",
          "#ERR ‚Äì allgemeiner Fehler beim Auswerten der Formel."
        ]
      }
    ]
  },
  modules: {
    title: "üìÅ Module, Abteilungen & Untermodule",
    subtitle: "So strukturierst du dein Werk statt 1000 Excel-Dateien.",
    keywords: ["abteilung","untermodul","hauptmodul","struktur","filter"],
    sections: [
      {
        heading: "Hauptmodul vs. Untermodul",
        items: [
          "Hauptmodul = Vorlage / Master, die du sperren kannst (Schreibschutz).",
          "Untermodul = Kopie eines Hauptmoduls, in der du frei arbeiten kannst.",
          "Untermodul-Erstellung: Hauptmodul anklicken ‚Üí 'Untermodul erstellen'."
        ]
      },
      {
        heading: "Abteilungen zuordnen",
        items: [
          "Jedes Modul kann einer oder mehreren Abteilungen zugeordnet werden.",
          "Klicke auf ‚öôÔ∏è in der Modulliste ‚Üí w√§hle, welche Abteilung auf dieses Modul Zugriff haben soll.",
          "Oben im Dropdown 'Abteilung' kannst du filtern, was in der Liste angezeigt wird."
        ]
      }
    ]
  },
  files: {
    title: "üíæ Import / Export & Dateien",
    subtitle: "Wie du Excel-Dateien reinholst und wieder raus gibst.",
    keywords: ["import","export","xlsx","csv","excel"],
    sections: [
      {
        heading: "Tabellendatei importieren",
        items: [
          "Klicke links auf '‚ûï Tabellendatei / CSV importieren'.",
          "W√§hle die Datei und das gew√ºnschte Sheet.",
          "Gib einen Modulnamen ein ‚Äì daraus wird ein Tenra-Modul.",
          "Formeln und Prozentwerte werden automatisch konvertiert."
        ]
      },
      {
        heading: "Daten exportieren",
        items: [
          "Rechts oben im Modul: ‚¨á XLSX oder ‚¨á CSV.",
          "Tenra schreibt die aktuellen Zellen zur√ºck in eine Datei.",
          "Alle Formeln bleiben als Text sichtbar (z. B. =A1+B1)."
        ]
      }
    ]
  },
  tools: {
    title: "üß∞ Freeze, Filter, Undo/Redo & Zoom",
    subtitle: "Die kleinen Dinge, die dich wie einen Profi wirken lassen.",
    keywords: ["freeze","filter","undo","redo","zoom","werkzeuge"],
    sections: [
      {
        heading: "Freeze & Filter",
        items: [
          "üìå Freeze: Fixiert Kopfzeilen / Index, damit du beim Scrollen die Struktur beh√§ltst.",
          "‚è∑ Filter: Aktivieren, um sp√§ter Filterlogik einzubauen (aktuell visuelle Vorbereitung)."
        ]
      },
      {
        heading: "Undo / Redo & Navigation",
        items: [
          "‚Ü∂ Undo, ‚Ü∑ Redo oder Strg+Z / Strg+Y funktionieren wie in Excel.",
          "Pfeiltasten bewegen die Auswahl, Shift+Klick markiert einen Bereich.",
          "Mit Maus an der Header-Kante ziehen = Spaltenbreite anpassen."
        ]
      },
      {
        heading: "Zoom & Fullscreen",
        items: [
          "Zoom +/‚Äì oben in der Leiste ‚Üí komplette Matrix gr√∂√üer/kleiner.",
          "‚õ∂ Fullscreen: Nur die Matrix, alles andere ausgeblendet ‚Äì ideal f√ºr gro√üe Monitore."
        ]
      }
    ]
  },
  comments: {
    title: "üí¨ Kommentare, Rechtsklick & Kontextmen√º",
    subtitle: "Wie du aus einer Tabelle ein Kommunikations-Board machst.",
    keywords: ["kommentar","rechtsklick","context","hinweis"],
    sections: [
      {
        heading: "Rechtsklick-Men√º",
        items: [
          "Rechtsklick auf eine Zelle √∂ffnet das Kontextmen√º.",
          "Funktionen: Kopieren, Einf√ºgen, Kommentar, Inhalt l√∂schen.",
          "Kommentare markieren die Zelle mit einer kleinen Ecke oben rechts."
        ]
      },
      {
        heading: "Kommentare nutzen",
        items: [
          "Nutze Kommentare f√ºr Erkl√§rungen, offene Punkte oder √úbergabe-Hinweise.",
          "Beim Hovern wird der Kommentar als Tooltip eingeblendet.",
          "So bleibt die Tabelle clean, aber trotzdem verst√§ndlich."
        ]
      }
    ]
  }
};

function getTutorialContextHint() {
  const total = state.modules?.length || 0;
  const abtId = state.currentDeptFilter;

  if (!total) {
    return "Starte mit einem Excel-Import oder lege links ein leeres Modul an. Tenra Matrix wird dann automatisch deine erste Tabelle erzeugen.";
  }

  if (abtId && !state.modules.some(m => (m.abteilungen || []).includes(abtId))) {
    return "F√ºr diese Abteilung gibt es noch keine Module. Erstelle ein neues Hauptmodul oder bearbeite bestehende Module √ºber ‚öôÔ∏è und f√ºge die Abteilung hinzu.";
  }

  if (total < 5) {
    return "Du hast bereits erste Module angelegt. Nutze Untermodule, um Varianten zu testen, ohne deine Master-Struktur zu zerst√∂ren.";
  }

  return "Du nutzt Tenra Matrix bereits intensiv. Schau dir jetzt Freeze, Kommentare und Schreibschutz an, um deine Module wie professionelle Templates zu pflegen.";
}

function renderTutorial() {
  

  const container = document.getElementById("tutorialContainer");
  if (!container) return;

  const hint = getTutorialContextHint();

  container.innerHTML = `
    <div class="tutorial-header-text">
      Tenra Academy ‚Äì kurze, fokussierte Erkl√§rungen f√ºr alles, was du in der Matrix tun kannst.
    </div>

    <input
      id="tutorialSearch"
      type="text"
      placeholder="üîç Was m√∂chtest du lernen? (z. B. Prozente, Untermodul, Import, Kommentare‚Ä¶)"
      oninput="tutorialSearch(this.value)"
    />

    <div id="tutorialCards" class="tutorial-cards-row">
      ${Object.entries(tutorialTopics).map(([id, t]) => `
        <div class="tutorial-card" data-id="${id}" onclick="openTutorial('${id}')">
          <div class="tutorial-card-title">${t.title}</div>
          <div class="tutorial-card-sub">${t.subtitle}</div>
        </div>
      `).join("")}
    </div>

    <div id="tutorialContent" class="tutorial-content">
      <div class="tutorial-section">
        <h3>Willkommen in Tenra Matrix</h3>
        <p>${hint}</p>
        <ul>
          <li>Links Module ausw√§hlen oder erstellen.</li>
          <li>Rechts arbeiten wie in klassischen Tabellenprogrammenllendatei ‚Äì nur stabiler f√ºr deinen Shopfloor.</li>
          <li>Nutze die Karten oben, um gezielt Themen zu vertiefen.</li>
        </ul>
        <div class="tutorial-chip-row">
          <span class="tutorial-chip">‚ùó Kein Modul ausgew√§hlt</span>
          <span class="tutorial-chip">‚ûï Tabellendatei / CSV importieren</span>
          <span class="tutorial-chip">üìÅ Hauptmodule & Untermodule</span>
        </div>
      </div>
    </div>
  `;

  // Direkt die Grundlagen-Karte aktivieren
  openTutorial("basics");
}

function openTutorial(id) {
  const topic = tutorialTopics[id];
  if (!topic) return;

  const contentEl = document.getElementById("tutorialContent");
  if (!contentEl) return;

  // aktive Karte markieren
  const cardsRow = document.getElementById("tutorialCards");
  if (cardsRow) {
    cardsRow.querySelectorAll(".tutorial-card").forEach(card => {
      const isActive = card.dataset.id === id;
      card.classList.toggle("active", isActive);
    });
  }

  let html = `
    <div class="tutorial-section">
      <h3>${topic.title}</h3>
      <p>${topic.subtitle}</p>
    </div>
  `;

  (topic.sections || []).forEach(sec => {
    html += `
      <div class="tutorial-section">
        <h3>${sec.heading}</h3>
        <ul>
          ${sec.items.map(li => `<li>${li}</li>`).join("")}
        </ul>
      </div>
    `;
  });

  contentEl.innerHTML = html;
}

function tutorialSearch(query) {
  const q = (query || "").trim().toLowerCase();
  const cardsRow = document.getElementById("tutorialCards");
  if (!cardsRow) return;

  const cards = Array.from(cardsRow.querySelectorAll(".tutorial-card"));

  // Karten visuell filtern
  cards.forEach(card => {
    if (!q) {
      card.style.opacity = "1";
      card.style.pointerEvents = "auto";
      return;
    }
    const text = card.textContent.toLowerCase();
    const match = text.includes(q);
    card.style.opacity = match ? "1" : "0.25";
    card.style.pointerEvents = match ? "auto" : "none";
  });

  if (!q) return;

  // passende Topic-ID suchen
  let bestId = null;
  for (const [id, topic] of Object.entries(tutorialTopics)) {
    const title = topic.title.toLowerCase();
    const sub = (topic.subtitle || "").toLowerCase();
    const kw = (topic.keywords || []).join(" ").toLowerCase();

    if (title.includes(q) || sub.includes(q) || kw.includes(q)) {
      bestId = id;
      break;
    }
  }

  if (bestId) {
    openTutorial(bestId);
  }
}

// Weil wir type="module" nutzen, m√ºssen wir es ans window h√§ngen
window.openTutorial = openTutorial;
window.tutorialSearch = tutorialSearch;

    function gridKey(row, colLabel, sheetName = state.sheetName) {
      return `${sheetName}:${row}:${colLabel}`;
    }

    function indexToColLabel(idx) {
      let n = idx + 1;
      let s = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    function colLabelToIndex(label) {
      let n = 0;
      const up = label.toUpperCase();
      for (let i = 0; i < up.length; i++) {
        n = n * 26 + (up.charCodeAt(i) - 64);
      }
      return n - 1;
    }

    function refToRowCol(ref) {
      const m = /^([A-Z]+)([0-9]+)$/i.exec(ref.trim());
      if (!m) return null;
      return { colLabel: m[1].toUpperCase(), row: Number(m[2]) };
    }

    function getCellObject(row, colLabel, sheetName = state.sheetName) {
      return state.grid[gridKey(row, colLabel, sheetName)] || null;
    }

    function getCellNumeric(row, colLabel, sheetName = state.sheetName, depth = 0) {
      const cell = getCellObject(row, colLabel, sheetName);
      if (!cell) return 0;

      if (cell.formula) {
        const v = evaluateFormula(cell.formula, sheetName, depth + 1);
        const num = Number(v);
        return Number.isFinite(num) ? num : 0;
      }

      const raw = cell.value;
      if (raw === null || raw === undefined || raw === "") return 0;
      const n = Number(raw);
      if (Number.isFinite(n)) return n;
      const percentMatch = /^(-?\d+(\.\d+)?)\s*%$/.exec(String(raw).trim());
      if (percentMatch) {
        return Number(percentMatch[1]) / 100;
      }
      return 0;
    }

    function evaluateFormula(rawFormula, sheetName = state.sheetName, depth = 0) {
      if (!rawFormula || typeof rawFormula !== "string") return rawFormula;
      if (!rawFormula.startsWith("=")) return rawFormula;
      if (depth > 40) return "#CYCLE";

      let expr = rawFormula.slice(1);

      expr = expr.replace(/(\d+(\.\d+)?)\s*%/g, (_, num) => {
        return String(Number(num) / 100);
      });

      expr = expr.replace(/SUM\s*\(/gi, "__SUM(");
      expr = expr.replace(/AVERAGE\s*\(/gi, "__AVG(");
      expr = expr.replace(/MIN\s*\(/gi, "__MIN(");
      expr = expr.replace(/MAX\s*\(/gi, "__MAX(");
      expr = expr.replace(/ABS\s*\(/gi, "Math.abs(");
      expr = expr.replace(/ROUND\s*\(/gi, "Math.round(");

      expr = expr.replace(/([A-Z]+[0-9]+)\s*:\s*([A-Z]+[0-9]+)/g, (_, ref1, ref2) => {
        return `__RANGE("${ref1.toLowerCase()}","${ref2.toLowerCase()}")`;
      });

      expr = expr.replace(/([A-Z]+)([0-9]+)/g, (match, col, row) => {
        return `__CELL("${col.toUpperCase()}",${Number(row)})`;
      });

      expr = expr.replace(/\^/g, "**");

      try {
        const __CELL = (colLabel, row) => {
          if (row < 1) throw new Error("#REF!");
          const colIndex = colLabelToIndex(colLabel);
          if (colIndex < 0 || colIndex > 16383) throw new Error("#REF!");
          return getCellNumeric(row, colLabel, sheetName, depth + 1);
        };

        const __RANGE = (startRef, endRef) => {
          const s = refToRowCol(String(startRef).toUpperCase());
          const e = refToRowCol(String(endRef).toUpperCase());
          if (!s || !e) return [];
          const rowStart = Math.min(s.row, e.row);
          const rowEnd   = Math.max(s.row, e.row);
          const colStart = colLabelToIndex(s.colLabel);
          const colEnd   = colLabelToIndex(e.colLabel);
          const values = [];
          for (let r = rowStart; r <= rowEnd; r++) {
            for (let c = colStart; c <= colEnd; c++) {
              values.push(getCellNumeric(r, indexToColLabel(c), sheetName, depth + 1));
            }
          }
          return values;
        };

        const flattenArgs = (args) => {
          const out = [];
          for (const a of args) {
            if (Array.isArray(a)) out.push(...flattenArgs(a));
            else out.push(a);
          }
          return out;
        };

        const __SUM = (...args) => {
          const flat = flattenArgs(args).map(Number).filter(x => Number.isFinite(x));
          return flat.reduce((acc, v) => acc + v, 0);
        };
        const __AVG = (...args) => {
          const flat = flattenArgs(args).map(Number).filter(x => Number.isFinite(x));
          if (!flat.length) return 0;
          return flat.reduce((a, v) => a + v, 0) / flat.length;
        };
        const __MIN = (...args) => {
          const flat = flattenArgs(args).map(Number).filter(x => Number.isFinite(x));
          return flat.length ? Math.min(...flat) : 0;
        };
        const __MAX = (...args) => {
          const flat = flattenArgs(args).map(Number).filter(x => Number.isFinite(x));
          return flat.length ? Math.max(...flat) : 0;
        };

        const result = eval(expr);
        if (result === Infinity || result === -Infinity) return "#DIV/0!";
        if (Number.isNaN(result)) return "#ERR";
        return result;
      } catch (err) {
        if (typeof err?.message === "string" && err.message.startsWith("#")) {
          return err.message;
        }
        if (err instanceof ReferenceError) return "#NAME?";
        return "#ERR";
      }
    }

    function renderModuleList() {
  const modules = state.modules || [];
// Suchfilter
const searchQ = (state.searchQuery || "").toLowerCase();
const filteredModules = modules.filter(m =>
  m.name.toLowerCase().includes(searchQ)
);

  // Falls noch nichts geladen
  if (!filteredModules.length) {
    moduleListEl.innerHTML = "<p class='muted'>Noch keine Module vorhanden.</p>";
    moduleDetailEl.style.display = "none";
    noModuleEl.style.display = "block";
    renderTutorial();

    return;
  }

  // ========== HAUPT- UND UNTERMODULE GRUPPIEREN ==========
 const mains = filteredModules.filter(m => m.is_main);
const subs  = filteredModules.filter(m => !m.is_main);


  // Kindern zuweisen
  for (const main of mains) {
    main.children = subs.filter(s => s.parent_id === main.id);
  }
// ===== DEPARTMENTS & LINES FILTER =====
const filterAbt = state.currentDeptFilter;
const filterLine = state.currentLineFilter;

function matchesFilters(mod) {
  // Modul hat Abteilungen: (mod.abteilungen = Array)
  const abtMatch = !filterAbt || (mod.abteilungen || []).includes(filterAbt);

  // Linienfilter (optional, sp√§ter f√ºr Untermodule)
return abtMatch;

}

  // ========== HTML RENDERN ==========
  moduleListEl.innerHTML = mains.map(main => {
    const activeMain = state.currentModule?.id === main.id;
    const createdAtMain = main.created_at
      ? new Date(main.created_at).toLocaleString()
      : "";

    // Hauptmodul
    const isLocked = main.is_main; // Hauptmodule sind gesperrt
const fadedMain = !matchesFilters(main);

let block = `
  <div class="module-item ${isLocked ? "locked" : ""} ${activeMain ? "active" : ""} ${fadedMain ? "faded" : ""}"
       data-id="${main.id}"
       data-type="main"
       ${fadedMain ? 'style="opacity:0.45;pointer-events:none;"' : ""}>
       
       <div style="display:flex;align-items:center;gap:8px;">
  <span class="name">üìÅ ${main.name}</span>
  <button class="dept-btn" data-id="${main.id}" title="Abteilungen setzen">‚öôÔ∏è</button>
</div>



        <span class="meta">${main.excel_filename || "ohne Datei"}</span>
        <span class="meta">${createdAtMain}</span>
        <span class="badge">Hauptmodul</span>
      </div>
    `;

    // Untermodule
    const subBlocks = main.children.map(sub => {
      const activeSub = state.currentModule?.id === sub.id;
      const createdAtSub = sub.created_at
        ? new Date(sub.created_at).toLocaleString()
        : "";

      const fadedSub = !matchesFilters(sub);

return `
  <div class="module-item sub ${activeSub ? "active" : ""} ${fadedSub ? "faded" : ""}"
       data-id="${sub.id}"
       data-type="sub"
       style="margin-left:14px; ${fadedSub ? "opacity:0.45;pointer-events:none;" : ""}">
       
        <span class="name">‚Ü≥ ${sub.name}</span>
        <span class="meta">${sub.excel_filename || "ohne Datei"}</span>
        <span class="meta">${createdAtSub}</span>
  </div>
`;

    }).join("");

    return block + subBlocks;
  }).join("");

  // ========== CLICK HANDLER ==========
  moduleListEl.querySelectorAll(".module-item").forEach(el => {
    el.addEventListener("click", () => {
      const type = el.dataset.type;

      // Hauptmodul gesperrt?
     

      selectModule(el.dataset.id);
    });
  });
  // Extra: Abteilungs-Button (‚öôÔ∏è)
moduleListEl.querySelectorAll(".dept-btn").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation(); // verhindert selectModule()
    openDeptPopup(btn.dataset.id);
  });
});
}

const moduleSearchEl = document.getElementById("moduleSearch");

moduleSearchEl.addEventListener("input", () => {
  const query = moduleSearchEl.value.toLowerCase().trim();
  state.searchQuery = query;
  renderModuleList();
});


    function humanFormatValue(raw, displayFormulaResult = true) {
      if (raw === null || raw === undefined) return "";
      return String(raw);
    }

    function computeConditionalClasses(evaluated) {
      if (typeof evaluated === "string") {
        if (evaluated.startsWith("#")) return ["error-cell"];
        const val = Number(evaluated);
        if (!Number.isFinite(val)) return [];
        if (val < 0) return ["negative"];
        if (val > 0) return ["positive"];
        if (val === 0) return ["zero"];
        return [];
      }
      if (typeof evaluated === "number") {
        if (evaluated < 0) return ["negative"];
        if (evaluated > 0) return ["positive"];
        if (evaluated === 0) return ["zero"];
      }
      return [];
    }

   function showMainLockedPopup(mainId) {
  const popup = document.getElementById("popup-under");
  popup.style.display = "flex";

  // Buttons
  document.getElementById("popup-no").onclick = () => {
    popup.style.display = "none";
  };

  document.getElementById("popup-yes").onclick = async () => {
    const name = document.getElementById("under-name").value.trim();
    if (!name) {
      alert("Bitte Namen eingeben.");
      return;
    }

    await createUntermodul(mainId, name);

    document.getElementById("under-name").value = "";
    popup.style.display = "none";

    await loadModules();
    renderModuleList();

    // direkt das neue Modul ausw√§hlen
selectModule(newModule.id);
  };
}



    function renderGrid() {
  if (!state.currentModule) return;

  // ==== SCROLL-POSITION MERKEN (Fix gegen Hochspringen) ====
  const oldWrapper = document.getElementById("gridWrapper");
  const scrollTopBefore  = oldWrapper ? oldWrapper.scrollTop  : 0;
  const scrollLeftBefore = oldWrapper ? oldWrapper.scrollLeft : 0;

  const sheetName = state.sheetName;
  const selected = state.selectedCell;
  const selectedKey = selected
    ? gridKey(selected.row, selected.colLabel, selected.sheetName || sheetName)
    : null;

  const range = state.selectionRange;
  const hasRange = !!range && range.sheetName === sheetName;

  const rows = [];
  for (let r = 1; r <= state.maxRow; r++) rows.push(r);

  const cols = [];
  for (let c = 0; c <= state.maxColIndex; c++) cols.push(c);

  // ==== FULLSCREEN BUTTON (NEU) ====
  let html = `
    <div class="grid-shell">
      <div class="grid-top-bar">
        <div class="sheet-tabs" id="sheetTabs">
          ${state.sheets.map(name => `
            <div class="sheet-tab ${name === sheetName ? "active" : ""}" data-sheet="${name}">
              <span>${name}</span>
            </div>
          `).join("")}
        </div>

        <div style="display:flex;align-items:center;gap:12px;">
          <button id="fullscreenBtn" class="small ghost icon" type="button">‚õ∂</button>

          <span class="zoom-indicator">Zoom: ${(state.zoom * 100).toFixed(0)}%</span>
          <div style="display:flex;gap:4px;">
            <button class="small ghost icon" type="button" data-zoom="out">‚Äì</button>
            <button class="small ghost icon" type="button" data-zoom="in">+</button>
          </div>
        </div>
      </div>

      <div class="grid-wrapper" id="gridWrapper" style="transform:scale(${state.zoom}); transform-origin: top left;">
        <table class="sheet">
          <thead>
            <tr>
              <th class="row-header"></th>
  `;

  for (let c = 0; c < cols.length; c++) {
    const label = indexToColLabel(cols[c]);
    html += `
      <th data-col="${label}">
        <div style="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
          <span>${label}</span>
          <div class="col-resize-handle" data-resize="${label}"></div>
        </div>
      </th>
    `;
  }

  html += `</tr></thead><tbody>`;

  for (let ri = 0; ri < rows.length; ri++) {
    const r = rows[ri];
    html += `<tr><td class="row-header">${r}</td>`;

    for (let ci = 0; ci < cols.length; ci++) {
      const colIndex = cols[ci];
      const colLabel = indexToColLabel(colIndex);
      const key = gridKey(r, colLabel, sheetName);
      const cell = state.grid[key];

      let rawDisplay = "";
      let evaluated = null;

      if (cell) {
        if (cell.formula) {
          evaluated = evaluateFormula(cell.formula, sheetName, 0);
          rawDisplay = evaluated;
        } else if (cell.value !== null && cell.value !== undefined && cell.value !== "") {
          rawDisplay = cell.value;
          evaluated = Number(cell.value);
        }
      }

      const isSelected = key === selectedKey;

      const classList = ["excel-cell"];
      if (isSelected) classList.push("selected");

      if (hasRange) {
        const colIdx = colLabelToIndex(colLabel);
        if (
          r >= range.startRow && r <= range.endRow &&
          colIdx >= range.startColIndex && colIdx <= range.endColIndex
        ) {
          if (!isSelected) classList.push("in-range");
        }
      }

      const condClasses = computeConditionalClasses(evaluated);
      classList.push(...condClasses);

      const hasComment = !!state.comments[key];
      const display = humanFormatValue(rawDisplay);

      html += `
        <td class="${classList.join(" ")}"
            data-row="${r}" data-col="${colLabel}" data-key="${key}">
          ${display}
          ${hasComment ? '<div class="cell-comment-indicator"></div>' : ""}
        </td>
      `;
    }

    html += `</tr>`;
  }

  html += `</tbody></table></div></div>`;
  tableContainer.innerHTML = html;

  // ========== SCROLL-POSITION WIEDERHERSTELLEN ==========
  const newWrapper = document.getElementById("gridWrapper");
  if (newWrapper) {
    newWrapper.scrollTop  = scrollTopBefore;
    newWrapper.scrollLeft = scrollLeftBefore;
  }

  // ===== Tabs =====
  const sheetTabsEl = document.getElementById("sheetTabs");
  sheetTabsEl.querySelectorAll(".sheet-tab").forEach(tab => {
    tab.addEventListener("click", () => {
      const sName = tab.dataset.sheet;
      state.sheetName = sName;
      if (!state.selectedCell) {
        state.selectedCell = { row: 1, colLabel: "A", sheetName: sName };
      } else {
        state.selectedCell.sheetName = sName;
      }
      syncFormulaBar();
      renderGrid();
    });
  });

  // ===== Zellen-Events =====
  newWrapper.querySelectorAll(".excel-cell").forEach(td => {
    td.addEventListener("click", (e) => handleCellClick(e, td));
    td.addEventListener("dblclick", (e) => {
  e.stopPropagation();
  e.preventDefault();
  startInlineEdit(td);
});

    td.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      openCellContextMenu(e, td);
    });
    td.addEventListener("mouseenter", (e) => {
      const key = td.dataset.key;
      const comment = state.comments[key];
      if (!comment) return;
      showCommentTooltip(e.clientX, e.clientY, comment);
    });
    td.addEventListener("mouseleave", hideCommentTooltip);
  });

  // ========== COLUMN RESIZE ==========
  newWrapper.querySelectorAll(".col-resize-handle").forEach(handle => {
    handle.addEventListener("mousedown", startColResize);
  });

  // ========== ZOOM ==========
  const zoomButtons = tableContainer.querySelectorAll("button[data-zoom]");
  zoomButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const dir = btn.dataset.zoom;
      if (dir === "in") state.zoom = Math.min(2, state.zoom + 0.1);
      else state.zoom = Math.max(0.6, state.zoom - 0.1);
      renderGrid();
    });
  });

  // ========== FULLSCREEN ==========
  const fullscreenBtn = document.getElementById("fullscreenBtn");
  fullscreenBtn.addEventListener("click", async () => {
  const elem = document.documentElement;

  if (!document.fullscreenElement) {
    await elem.requestFullscreen();
    document.body.classList.add("is-fullscreen");
  } else {
    document.body.classList.remove("is-fullscreen");
    await document.exitFullscreen();
  }
});

}


    function syncFormulaBar() {
      if (!state.selectedCell) {
        formulaBarEl.value = "";
        return;
      }
      const { row, colLabel, sheetName } = state.selectedCell;
      const cell = getCellObject(row, colLabel, sheetName);
      if (!cell) {
        formulaBarEl.value = "";
        return;
      }
      if (cell.formula) formulaBarEl.value = cell.formula;
      else formulaBarEl.value = cell.value ?? "";
    }

   function handleCellClick(e, td) {
  // üîí Schreibschutz: Hauptmodul -> Popup, keine Bearbeitung
  if (state.currentModule?.is_main === true &&
      state.currentModule?.is_locked === true) {
    showMainLockedPopup(state.currentModule.id);
    return;
  }

  const row = Number(td.dataset.row);
  const colLabel = td.dataset.col;
  const sheetName = state.sheetName;

  const wrapper = document.getElementById("gridWrapper");

  if (e.shiftKey && state.selectedCell) {
    // ==== RANGE-SELECTION (Shift + Klick) ====
    const startRow = state.selectedCell.row;
    const startColIndex = colLabelToIndex(state.selectedCell.colLabel);
    const endRow = row;
    const endColIndex = colLabelToIndex(colLabel);

    state.selectionRange = {
      startRow: Math.min(startRow, endRow),
      endRow: Math.max(startRow, endRow),
      startColIndex: Math.min(startColIndex, endColIndex),
      endColIndex: Math.max(startColIndex, endColIndex),
      sheetName
    };

    // alte Range-Klassen entfernen
    if (wrapper) {
      wrapper.querySelectorAll("td.excel-cell.in-range").forEach(el => {
        el.classList.remove("in-range");
      });
    }

    // neue Range-Klassen setzen
    if (wrapper) {
      for (let r = state.selectionRange.startRow; r <= state.selectionRange.endRow; r++) {
        for (let c = state.selectionRange.startColIndex; c <= state.selectionRange.endColIndex; c++) {
          const lbl = indexToColLabel(c);
          const cellEl = wrapper.querySelector(
            `td.excel-cell[data-row="${r}"][data-col="${lbl}"]`
          );
          if (cellEl) cellEl.classList.add("in-range");
        }
      }
    }
  } else {
    // ==== EINZEL-SELECTION ====
    if (wrapper) {
      wrapper.querySelectorAll("td.excel-cell.selected").forEach(el => {
        el.classList.remove("selected");
      });
      wrapper.querySelectorAll("td.excel-cell.in-range").forEach(el => {
        el.classList.remove("in-range");
      });
    }

    state.selectionRange = null;
    state.selectedCell = { row, colLabel, sheetName };
    td.classList.add("selected");
  }

  syncFormulaBar();
  // ‚ùå WICHTIG: KEIN renderGrid() mehr hier ‚Äì sonst flicker + dblclick kaputt
}


    function startInlineEdit(td) {
      // üîí Schreibschutz ‚Üí Inline-Edit verhindern
if (state.currentModule?.is_locked === true) {
  return; // keine Bearbeitung
}

      const row = Number(td.dataset.row);
      const colLabel = td.dataset.col;
      const sheetName = state.sheetName;
      const key = gridKey(row, colLabel, sheetName);
      const cell = state.grid[key];

      const oldText = td.innerText.trim();
     td.setAttribute("contenteditable", "true");      // Fullscreen-kompatibel
td.style.whiteSpace = "normal";                 // Zeilenumbruch beim Tippen
td.style.overflow = "visible";                  // Text nicht abgeschnitten
setTimeout(() => {
  td.focus({ preventScroll: true });
}, 0);

      const sel = document.getSelection();
      if (sel) {
        const range = document.createRange();
        range.selectNodeContents(td);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      const finish = async (commit) => {
       td.removeAttribute("contenteditable");
td.style.whiteSpace = "";
td.style.overflow = "";

        const newValue = td.innerText.trim();
        if (commit && newValue !== oldText) {
          await saveCell(row, colLabel, newValue, sheetName, true);
        } else {
          td.innerText = oldText;
        }
        syncFormulaBar();
      };

            const keydownHandler = (e) => {
        // WICHTIG: verhindert, dass der globale keydown-Handler feuert
        e.stopPropagation();

        if (e.key === "Enter") {
          e.preventDefault();
          finish(true);
        } else if (e.key === "Escape") {
          e.preventDefault();
          finish(false);
        }
      };

      const blurHandler = () => {
        finish(true);
      };

      td.addEventListener("keydown", keydownHandler, { once: true });
      td.addEventListener("blur", blurHandler, { once: true });

      if (cell?.formula) formulaBarEl.value = cell.formula;
      else formulaBarEl.value = cell?.value ?? "";
    }

    async function saveCell(row, colLabel, input, sheetName = state.sheetName, trackHistory = true) {
      // üîí Schreibschutz ‚Üí Speichern blocken
if (state.currentModule?.is_locked === true) {
  console.warn("Schreibschutz aktiv ‚Üí speichern blockiert");
  return;
}

      if (!state.currentModule) return;

      const colIndex = colLabelToIndex(colLabel);
      const key = gridKey(row, colLabel, sheetName);
      const prevCell = state.grid[key] ? { ...state.grid[key] } : { value: null, formula: null };

      const trimmed = (input ?? "").toString().trim();
      const isFormula = trimmed.startsWith("=");

      let value = null;
      let formula = null;

      if (isFormula) {
        formula = trimmed;
      } else {
        if (trimmed === "") {
          value = null;
        } else if (trimmed.endsWith("%")) {
          const num = parseFloat(trimmed);
          if (!Number.isNaN(num)) {
            value = String(num / 100);
          } else {
            value = trimmed;
          }
        } else {
          value = trimmed;
        }
      }

      const payload = {
        module_id: state.currentModule.id,
        row_index: row,
        col_index: colIndex,
        col_label: colLabel,
        value: value,
        formula: formula,
        created_by: state.user.id
      };

      const { error } = await supabase
        .from("excel_module_cells")
        .upsert(payload, { onConflict: "module_id,row_index,col_index" });

      if (error) {
        showError("Fehler beim Speichern: " + error.message);
        return;
      }

      state.grid[key] = {
        module_id: state.currentModule.id,
        row_index: row,
        col_index: colIndex,
        col_label: colLabel,
        sheetName,
        value,
        formula
      };

      if (trackHistory) {
        state.undoStack.push({
          type: "cell",
          moduleId: state.currentModule.id,
          sheetName,
          row,
          colLabel,
          before: prevCell,
          after: { value, formula }
        });
        state.redoStack = [];
      }

      hideError();
      renderGrid();
    }

    async function loadModules() {
      const { data, error } = await supabase
  .from("excel_modules")
  .select("id, firma_id, name, excel_filename, excel_sheet_name, created_by, created_at, is_main, is_locked, parent_id, abteilungen")

  .eq("firma_id", state.firma_id)
  .order("created_at", { ascending: false });


      if (error) {
        showError("Fehler beim Laden der Module.");
        moduleListEl.innerHTML = "<p class='muted'>Fehler beim Laden.</p>";
        return;
      }
      state.modules = data || [];
      renderModuleList();
    }
    async function createUntermodul(mainId, name) {
  // 1. Hauptmodul-Daten abrufen
  const { data: mainRows, error: mainErr } = await supabase
    .from("excel_modules")
    .select("*")
    .eq("id", mainId)
    .limit(1);

  if (mainErr || !mainRows?.length) {
    console.error("Fehler Hauptmodul laden:", mainErr);
    alert("Fehler beim Laden des Hauptmoduls.");
    return;
  }

  const main = mainRows[0];

  // 2. Excel-Daten (Zellen, Formeln etc.) aus der Tabelle excel_cells abrufen
  const { data: cellRows, error: cellErr } = await supabase
    .from("excel_module_cells")

    .select("*")
    .eq("module_id", mainId);

  if (cellErr) {
    console.error("Fehler Zellen laden:", cellErr);
    alert("Fehler beim Kopieren der Zellen.");
    return;
  }

  // 3. Untermodul erstellen (ohne Zellen, die kommen gleich)
  const { data: newModRows, error: newErr } = await supabase
    .from("excel_modules")
    .insert({
      firma_id: state.firma_id,
      name: name,
      excel_filename: main.excel_filename,
      excel_sheet_name: main.excel_sheet_name,
      is_main: false,
      parent_id: mainId,
      abteilungen: main.abteilungen || [],
      max_row: main.max_row,
      max_col: main.max_col,
      created_by: state.user.id
    })
    .select()
    .limit(1);

  if (newErr) {
    console.error("Fehler Untermodul erstellen:", newErr);
    alert("Fehler beim Erstellen des Untermoduls.");
    return;
  }

  const newModule = newModRows[0];

  // 4. Zellen kopieren (1:1)
  if (cellRows?.length > 0) {
   const cloned = cellRows.map(cell => ({
  module_id: newModule.id,

  row_index: cell.row_index,
  col_index: cell.col_index,
  col_label: cell.col_label,

  value: cell.value ?? null,
  formula: cell.formula ?? null,
  cell_type: cell.cell_type ?? null,

  created_by: state.user.id ?? null
}));


    const { error: cellInsertErr } = await supabase
      .from("excel_module_cells")

      .insert(cloned);

    if (cellInsertErr) {
      console.error("Fehler beim Kopieren der Zellen:", cellInsertErr);
      alert("Fehler beim Kopieren der Tabelleninhalte.");
      return;
    }
  }

  console.log("Untermodul erstellt:", newModule.id);
}



async function loadMatrixAbteilungenUndLinien() {
  try {
    const fid = state.firma_id;

    // üü¢ Abteilungen laden
    const { data: abtRows, error: err1 } = await supabase
      .from("abteilungen")
      .select("id, name")
      .eq("firma_id", fid)
      .order("name", { ascending: true });

    if (err1) throw err1;

    // üü¢ WICHTIG: im State speichern ‚Üí Popup braucht das
    state.departments = abtRows || [];

    // Dropdown f√ºllen
    // Custom Dropdown Elemente
const dropdown = document.getElementById("deptDropdown");
const selectedEl = dropdown.querySelector(".dropdown-selected");
const menuEl = document.getElementById("deptMenu");

// Men√º f√ºllen
menuEl.innerHTML = "";

// Erst hinzuf√ºgen: ALLE ‚Äî zeigt alle Module
const allItem = document.createElement("div");
allItem.className = "dropdown-item";
allItem.textContent = "Firma";
allItem.dataset.id = "";
allItem.onclick = () => {
  selectedEl.textContent = "Firma";
  state.currentDeptFilter = "";
  dropdown.classList.add("closing");
setTimeout(() => {
  dropdown.classList.remove("open");
  dropdown.classList.remove("closing");
}, 250);

  renderModuleList();
};
menuEl.appendChild(allItem);

// Dann normale Abteilungen
(abtRows || []).forEach(dep => {

  const item = document.createElement("div");
  item.className = "dropdown-item";
  item.textContent = dep.name;
  item.dataset.id = dep.id;

  item.onclick = () => {
    selectedEl.textContent = dep.name;
    state.currentDeptFilter = dep.id;
    dropdown.classList.add("closing");
setTimeout(() => {
  dropdown.classList.remove("open");
  dropdown.classList.remove("closing");
}, 250);

    renderModuleList();
  };

  menuEl.appendChild(item);
});

// Klick zum √ñffnen
dropdown.onclick = () => {
  dropdown.classList.toggle("open");
};

// Wenn Filter schon gesetzt war ‚Üí anzeigen
if (!state.currentDeptFilter || state.currentDeptFilter === "") {
  selectedEl.textContent = "Firma";
} else {
  const found = (abtRows || []).find(a => a.id == state.currentDeptFilter);
  selectedEl.textContent = found ? found.name : "Firma";
}



  } catch (e) {
    console.error("Fehler Matrix-Abteilungen:", e);
  }
}





    async function selectModule(id) {
  const module = state.modules.find(m => m.id === id);
  if (!module) return;

  state.currentModule = module;

 
  // ================================================

  state.selectedCell = null;
  state.selectionRange = null;
  formulaBarEl.value = "";
  state.undoStack = [];
  state.redoStack = [];
  state.sheetName = "Sheet1";
  state.sheets = ["Sheet1"];
  state.comments = {};
  state.filters = {};
  state.filterEnabled = false;


      filterToggleBtn.classList.toggle("toggle-on", state.filterEnabled);
      freezeToggleBtn.classList.toggle("toggle-on", state.freezeFirstRowCol);

      renderModuleList();
// === Untermodul-Button & Schreibschutz-Steuerung ===
const btn = document.getElementById("create-under-btn");
const lockBtn = document.getElementById("lockToggleBtn");

if (module.is_main) {
  // Untermodul
  btn.style.display = "inline-flex";
  btn.onclick = () => showMainLockedPopup(module.id);

  // Schreibschutz
  lockBtn.style.display = "inline-flex";
  lockBtn.textContent = module.is_locked
    ? "üîì Schreibschutz aufheben"
    : "üîí Schreibschutz aktivieren";
  lockBtn.onclick = () => toggleLock(module);

} else {
  btn.style.display = "none";
  lockBtn.style.display = "none";
}

      moduleDetailEl.style.display = "block";
      noModuleEl.style.display = "none";
      moduleTitleEl.textContent = module.name;
      moduleMetaEl.textContent =
        module.excel_filename
          ? `Datei: ${module.excel_filename} ‚Äì Sheet: ${module.excel_sheet_name || "n/a"}`
          : "";

      await loadGridForCurrentModule();
    }

    async function loadGridForCurrentModule() {
      if (!state.currentModule) return;
      tableContainer.innerHTML = "<div class='muted'>Lade Daten‚Ä¶</div>";

      const { data, error } = await supabase
        .from("excel_module_cells")
        .select("*")
        .eq("module_id", state.currentModule.id);

      if (error) {
        showError("Fehler beim Laden der Zellen.");
        tableContainer.innerHTML = "<div class='muted'>Fehler beim Laden.</div>";
        return;
      }

      state.grid = {};
      let maxRow = 0;
      let maxColIndex = 0;

      (data || []).forEach(cell => {
        const row = Number(cell.row_index);
        const colIndex = Number(cell.col_index);
        const colLabel = cell.col_label || indexToColLabel(colIndex);
        const sheetName = "Sheet1";

        const key = gridKey(row, colLabel, sheetName);
        state.grid[key] = {
          ...cell,
          row_index: row,
          col_index: colIndex,
          col_label: colLabel,
          sheetName
        };

        if (row > maxRow) maxRow = row;
        if (colIndex > maxColIndex) maxColIndex = colIndex;
      });

      state.maxRow = Math.max(maxRow || 0, 40);
      state.maxColIndex = Math.max(maxColIndex || 0, 15);
      hideError();
      renderGrid();
    }
async function toggleLock(module) {
  if (!module) return;

  const newValue = !module.is_locked;

  // In DB speichern
  const { error } = await supabase
    .from("excel_modules")
    .update({ is_locked: newValue })
    .eq("id", module.id);

  if (error) {
    alert("Fehler beim Umschalten des Schreibschutzes.");
    return;
  }

  // Lokal aktualisieren
  module.is_locked = newValue;

  // UI-Text anpassen
  const lockBtn = document.getElementById("lockToggleBtn");
  lockBtn.textContent = newValue
    ? "üîì Schreibschutz aufheben"
    : "üîí Schreibschutz aktivieren";

  // Liste neu rendern (damit gesperrt angezeigt wird)
  renderModuleList();

  // Grid neu rendern (damit Sperre wirkt)
  renderGrid();
}



    function showError(message) {
      errorBannerEl.textContent = message;
      errorBannerEl.style.display = "block";
    }
    function hideError() {
      errorBannerEl.style.display = "none";
    }

    deleteModuleBtn.addEventListener("click", async () => {
      if (!state.currentModule) return;
      if (!confirm("Modul wirklich l√∂schen?")) return;
      const id = state.currentModule.id;
      await supabase.from("excel_module_cells").delete().eq("module_id", id);
      await supabase.from("excel_modules").delete().eq("id", id);
      state.currentModule = null;
      
      state.grid = {};
      moduleDetailEl.style.display = "none";
      noModuleEl.style.display = "block";
      renderTutorial();

      await loadModules();
      state.currentModule = null;
noModuleEl.style.display = "block";
moduleDetailEl.style.display = "none";
renderTutorial();

      await loadMatrixAbteilungenUndLinien();

    });

    addRowBtn.addEventListener("click", () => {
      state.maxRow += 1;
      renderGrid();
    });

    addColBtn.addEventListener("click", () => {
      state.maxColIndex += 1;
      renderGrid();
    });

    async function handleFormulaBarEnter() {
      if (!state.selectedCell || !state.currentModule) return;
      const input = formulaBarEl.value ?? "";
      const { row, colLabel, sheetName } = state.selectedCell;
      await saveCell(row, colLabel, input, sheetName, true);
    }

    formulaBarEl.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        await handleFormulaBarEnter();
      }
    });

    formulaBarEl.addEventListener("input", () => {
      const val = formulaBarEl.value.trim();
      if (!val.startsWith("=")) {
        formulaSuggestionsEl.style.display = "none";
        return;
      }
      const namePart = val.slice(1).split("(")[0].toUpperCase();
      const suggestions = [
        { name: "SUM",      desc: "Summe von Werten oder Bereichen", example: "=SUM(A1:A10)" },
        { name: "AVERAGE",  desc: "Durchschnitt von Werten",         example: "=AVERAGE(B1:B5)" },
        { name: "MIN",      desc: "Kleinster Wert",                  example: "=MIN(C1:C10)" },
        { name: "MAX",      desc: "Gr√∂√üter Wert",                    example: "=MAX(C1:C10)" },
        { name: "ROUND",    desc: "Rundet eine Zahl",                example: "=ROUND(D1;2)" },
        { name: "ABS",      desc: "Absolutwert",                     example: "=ABS(E1)" }
      ];
      const matched = suggestions.filter(s => s.name.startsWith(namePart));
      if (!matched.length) {
        formulaSuggestionsEl.style.display = "none";
        return;
      }
      formulaSuggestionsEl.innerHTML = matched.map(s => `
        <div class="formula-suggestion" data-name="${s.name}" data-example="${s.example}">
          <span class="name">${s.name}</span>
          <span class="desc">${s.desc}</span>
        </div>
      `).join("");
      formulaSuggestionsEl.style.display = "block";
      formulaSuggestionsEl.querySelectorAll(".formula-suggestion").forEach(el => {
        el.addEventListener("click", () => {
          const name = el.dataset.name;
          const example = el.dataset.example;
          const current = formulaBarEl.value.trim();
          if (!current || current === "=") {
            formulaBarEl.value = example;
          } else {
            if (!current.includes("(")) {
              formulaBarEl.value = "=" + name + "(";
            } else {
              formulaBarEl.value = "=" + name + current.slice(1 + namePart.length);
            }
          }
          formulaSuggestionsEl.style.display = "none";
          formulaBarEl.focus();
        });
      });
    });

    document.addEventListener("click", (e) => {
      if (!formulaSuggestionsEl.contains(e.target) && e.target !== formulaBarEl) {
        formulaSuggestionsEl.style.display = "none";
      }
      closeContextMenu();
    });

    uploadBtn.addEventListener("click", () => excelInput.click());
    excelInput.addEventListener("change", handleExcelUpload);

    newEmptyModuleBtn.addEventListener("click", async () => {
      const name = prompt("Name des neuen Moduls:");
      if (!name) return;
      const { data: module, error } = await supabase
        .from("excel_modules")
.insert({
  firma_id: state.firma_id,
  name,
  excel_filename: null,
  excel_sheet_name: "Sheet1",
  is_main: true,
  parent_id: null,
  abteilungen: [],
  created_by: state.user.id
})

        .select()
        .single();
      if (error) {
        showError("Fehler beim Anlegen des Moduls.");
        return;
      }
      await loadModules();
      state.currentModule = null;
noModuleEl.style.display = "block";
moduleDetailEl.style.display = "none";
renderTutorial();

      await selectModule(module.id);
      await loadMatrixAbteilungenUndLinien();

    });

    async function handleExcelUpload(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      try {
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = async (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {
              type: "array",
              cellFormula: true
            });

            const sheetNames = wb.SheetNames;
            if (!sheetNames.length) {
              alert("Keine Sheets gefunden.");
              return;
            }

            let sheetName;
            if (sheetNames.length === 1) {
              sheetName = sheetNames[0];
            } else {
              const choice = prompt(
                sheetNames.map((n, i) => `${i+1}) ${n}`).join("\n") +
                "\n\nSheet w√§hlen (Nummer oder Name):"
              );
              if (!choice) return;
              if (!isNaN(Number(choice))) {
                sheetName = sheetNames[Number(choice) - 1];
              } else {
                sheetName = choice;
              }
            }

            const sheet = wb.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {
              header: 1,
              raw: false,
              cellFormula: true
            });

            const moduleName = prompt("Name des Moduls:");
            if (!moduleName) return;

            const { data: module, error: modErr } = await supabase
              .from("excel_modules")
              .insert({
                firma_id: state.firma_id,
                name: moduleName,
                excel_filename: file.name,
                excel_sheet_name: sheetName,
                created_by: state.user.id
              })
              .select()
              .single();

            if (modErr) {
              console.error(modErr);
              alert("Fehler beim Anlegen des Moduls.");
              return;
            }

            const module_id = module.id;
            const inserts = [];

            json.forEach((rowArr, rIdx) => {
              rowArr.forEach((cell, cIdx) => {
                let value = null;
                let formula = null;

                if (cell !== null && cell !== undefined) {
                  if (typeof cell === "object" && cell !== null) {
                    if (cell.f) {
                      formula = "=" + cell.f;
                    }
                    if (cell.v !== undefined && cell.v !== null && cell.v !== "") {
                      let v = String(cell.v);
                      if (typeof v === "string" && v.trim().endsWith("%")) {
                        const num = parseFloat(v);
                        if (!isNaN(num)) {
                          v = String(num / 100);
                        }
                      }
                      value = v;
                    }
                  } else if (cell !== "") {
                    let v = String(cell);
                    if (v.trim().endsWith("%")) {
                      const num = parseFloat(v);
                      if (!isNaN(num)) {
                        v = String(num / 100);
                      }
                    }
                    value = v;
                  }
                }

                if (value !== null || formula !== null) {
                  inserts.push({
                    module_id,
                    row_index: rIdx + 1,
                    col_index: cIdx,
                    col_label: indexToColLabel(cIdx),
                    value,
                    formula,
                    created_by: state.user.id
                  });
                }
              });
            });

            if (inserts.length) {
              const { error: insErr } = await supabase
                .from("excel_module_cells")
                .insert(inserts);
              if (insErr) console.error(insErr);
            }

            await loadModules();
            state.currentModule = null;
noModuleEl.style.display = "block";
moduleDetailEl.style.display = "none";
renderTutorial();

            await loadMatrixAbteilungenUndLinien();

            await selectModule(module_id);
            alert("Tabellendatei importiert.");
          } catch (err) {
            console.error(err);
            alert("Fehler beim Import: " + err.message);
          } finally {
            evt.target.value = "";
          }
        };
      } catch (err) {
        console.error(err);
        alert("Fehler beim Lesen der Datei.");
        evt.target.value = "";
      }
    }

    undoBtn.addEventListener("click", () => performUndo());
    redoBtn.addEventListener("click", () => performRedo());

    async function performUndo() {
      const op = state.undoStack.pop();
      if (!op) return;
      state.redoStack.push(op);
      if (op.type === "cell") {
        const { row, colLabel, sheetName, before } = op;
        await saveCell(row, colLabel, before.formula ?? before.value ?? "", sheetName, false);
      }
    }

    async function performRedo() {
      const op = state.redoStack.pop();
      if (!op) return;
      state.undoStack.push(op);
      if (op.type === "cell") {
        const { row, colLabel, sheetName, after } = op;
        await saveCell(row, colLabel, after.formula ?? after.value ?? "", sheetName, false);
      }
    }

    function showCommentTooltip(x, y, text) {
      let tooltip = document.getElementById("commentTooltip");
      if (!tooltip) {
        tooltip = document.createElement("div");
        tooltip.id = "commentTooltip";
        tooltip.className = "comment-tooltip";
        document.body.appendChild(tooltip);
      }
      tooltip.textContent = text;
      tooltip.style.left = (x + 10) + "px";
      tooltip.style.top = (y + 10) + "px";
      tooltip.style.display = "block";
    }
    function hideCommentTooltip() {
      const tooltip = document.getElementById("commentTooltip");
      if (tooltip) tooltip.style.display = "none";
    }

    let activeContextMenu = null;
    function openCellContextMenu(e, td) {
      closeContextMenu();

      const row = Number(td.dataset.row);
      const colLabel = td.dataset.col;
      const sheetName = state.sheetName;
      const key = gridKey(row, colLabel, sheetName);

      const menu = document.createElement("div");
      menu.className = "context-menu";
      menu.innerHTML = `
        <div class="context-menu-item" data-action="copy">Kopieren <span class="shortcut">Strg+C</span></div>
        <div class="context-menu-item" data-action="paste">Einf√ºgen <span class="shortcut">Strg+V</span></div>
        <div class="context-menu-item" data-action="comment">Kommentar‚Ä¶</div>
        <div class="context-menu-item" data-action="clear">Inhalt l√∂schen</div>
      `;
      document.body.appendChild(menu);
      const rect = menu.getBoundingClientRect();
      const x = Math.min(e.clientX, window.innerWidth - rect.width - 8);
      const y = Math.min(e.clientY, window.innerHeight - rect.height - 8);
      menu.style.left = x + "px";
      menu.style.top  = y + "px";

      menu.querySelectorAll(".context-menu-item").forEach(item => {
        item.addEventListener("click", async () => {
          const action = item.dataset.action;
          if (action === "copy") {
            await handleCopy();
          } else if (action === "paste") {
            await handlePaste();
          } else if (action === "comment") {
            const current = state.comments[key] || "";
            const text = prompt("Kommentar f√ºr diese Zelle:", current);
            if (text !== null) {
              if (text.trim() === "") delete state.comments[key];
              else state.comments[key] = text.trim();
              renderGrid();
            }
          } else if (action === "clear") {
            await saveCell(row, colLabel, "", sheetName, true);
          }
          closeContextMenu();
        });
      });

      activeContextMenu = menu;
    }
    function closeContextMenu() {
      if (activeContextMenu) {
        activeContextMenu.remove();
        activeContextMenu = null;
      }
    }

    document.addEventListener("keydown", async (e) => {
      // üîí Schreibschutz blockiert Tastatur-√Ñnderungen
if (state.currentModule?.is_locked === true) {
  if (document.getElementById("deptPopup").style.display === "flex") return;
  if (document.getElementById("popup-under").style.display === "flex") return;
  // Navigation erlauben
  const allowed = ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab"];
  
  if (!allowed.includes(e.key)) {
    e.preventDefault();
    return; 
  }
}

      if (e.target === formulaBarEl || e.target === searchInput || e.target === replaceInput) return;

      const ctrl = e.ctrlKey || e.metaKey;
      if (ctrl && e.key.toLowerCase() === "c") {
        e.preventDefault();
        await handleCopy();
      } else if (ctrl && e.key.toLowerCase() === "v") {
        e.preventDefault();
        await handlePaste();
      } else if (ctrl && e.key.toLowerCase() === "z") {
        e.preventDefault();
        await performUndo();
      } else if (ctrl && e.key.toLowerCase() === "y") {
        e.preventDefault();
        await performRedo();
      } else if (e.key === "Delete") {
        e.preventDefault();
        await clearSelection();
      } else if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Enter"].includes(e.key)) {
        e.preventDefault();
        moveSelection(e.key, e.shiftKey);
      }
    });

    async function handleCopy() {
      if (!state.selectedCell && !state.selectionRange) return;

      let cells = [];
      if (state.selectionRange) {
        const { startRow, endRow, startColIndex, endColIndex, sheetName } = state.selectionRange;
        for (let r = startRow; r <= endRow; r++) {
          const rowArr = [];
          for (let c = startColIndex; c <= endColIndex; c++) {
            const colLabel = indexToColLabel(c);
            const cell = getCellObject(r, colLabel, sheetName);
            rowArr.push(cell ? { value: cell.value, formula: cell.formula } : { value: null, formula: null });
          }
          cells.push(rowArr);
        }
      } else if (state.selectedCell) {
        const { row, colLabel, sheetName } = state.selectedCell;
        const cell = getCellObject(row, colLabel, sheetName);
        cells = [[cell ? { value: cell.value, formula: cell.formula } : { value: null, formula: null }]];
      }

      state.clipboard = { cells, rows: cells.length, cols: cells[0]?.length ?? 0 };

      try {
        const plain = cells.map(row => row.map(c => c.formula ?? c.value ?? "").join("\t")).join("\n");
        await navigator.clipboard.writeText(plain);
      } catch (_) {}
    }

    async function handlePaste() {
      if (!state.clipboard || !state.selectedCell) return;
      const { row, colLabel, sheetName } = state.selectedCell;
      const startRow = row;
      const startColIndex = colLabelToIndex(colLabel);

      const { cells, rows, cols } = state.clipboard;
      for (let rOff = 0; rOff < rows; rOff++) {
        for (let cOff = 0; cOff < cols; cOff++) {
          const targetRow = startRow + rOff;
          const targetColIndex = startColIndex + cOff;
          const targetColLabel = indexToColLabel(targetColIndex);
          const src = cells[rOff][cOff];
          const input = src.formula ?? src.value ?? "";
          if (input === "" || input === null) continue;
          await saveCell(targetRow, targetColLabel, input, sheetName, true);
        }
      }
    }

    async function clearSelection() {
      if (state.selectionRange) {
        const { startRow, endRow, startColIndex, endColIndex, sheetName } = state.selectionRange;
        for (let r = startRow; r <= endRow; r++) {
          for (let c = startColIndex; c <= endColIndex; c++) {
            await saveCell(r, indexToColLabel(c), "", sheetName, true);
          }
        }
      } else if (state.selectedCell) {
        const { row, colLabel, sheetName } = state.selectedCell;
        await saveCell(row, colLabel, "", sheetName, true);
      }
    }

    function moveSelection(key, shift) {
      if (!state.selectedCell) {
        state.selectedCell = { row: 1, colLabel: "A", sheetName: state.sheetName };
        syncFormulaBar();
        renderGrid();
        return;
      }
      let { row, colLabel, sheetName } = state.selectedCell;
      let r = row;
      let c = colLabelToIndex(colLabel);

      if (key === "ArrowUp") r = Math.max(1, r - 1);
      else if (key === "ArrowDown") r = Math.min(state.maxRow, r + 1);
      else if (key === "ArrowLeft") c = Math.max(0, c - 1);
      else if (key === "ArrowRight" || key === "Tab") c = Math.min(state.maxColIndex, c + 1);
      else if (key === "Enter") r = Math.min(state.maxRow, r + 1);

      const newColLabel = indexToColLabel(c);
      state.selectedCell = { row: r, colLabel: newColLabel, sheetName };
      if (shift) {
        const startRow = row;
        const startColIndex = colLabelToIndex(colLabel);
        state.selectionRange = {
          startRow: Math.min(startRow, r),
          endRow: Math.max(startRow, r),
          startColIndex: Math.min(startColIndex, c),
          endColIndex: Math.max(startColIndex, c),
          sheetName
        };
      } else {
        state.selectionRange = null;
      }
      syncFormulaBar();
      renderGrid();
    }

    let resizing = null;
    function startColResize(e) {
      const label = e.target.dataset.resize;
      const th = e.target.closest("th");
      if (!th) return;
      const startX = e.clientX;
      const startWidth = th.offsetWidth;
      resizing = { th, label, startX, startWidth };
      document.addEventListener("mousemove", onColResizeMove);
      document.addEventListener("mouseup", onColResizeEnd, { once: true });
    }
    function onColResizeMove(e) {
      if (!resizing) return;
      const delta = e.clientX - resizing.startX;
      const newWidth = Math.max(40, resizing.startWidth + delta);
      resizing.th.style.width = newWidth + "px";
      resizing.th.style.minWidth = newWidth + "px";
      resizing.th.style.maxWidth = newWidth + "px";
    }
    function onColResizeEnd() {
      document.removeEventListener("mousemove", onColResizeMove);
      resizing = null;
    }

    searchNextBtn.addEventListener("click", () => performSearch(false));
    replaceOneBtn.addEventListener("click", () => performReplace(false));
    replaceAllBtn.addEventListener("click", () => performReplace(true));

    function performSearch(resetIndex) {
      const term = searchInput.value ?? "";
      if (!term) {
        state.lastSearchResults = [];
        state.lastSearchIndex = -1;
        searchStatusEl.textContent = "0 Treffer";
        return;
      }
      if (!state.lastSearchResults.length || resetIndex) {
        const results = [];
        const sheetName = state.sheetName;
        for (let r = 1; r <= state.maxRow; r++) {
          for (let cIdx = 0; cIdx <= state.maxColIndex; cIdx++) {
            const colLabel = indexToColLabel(cIdx);
            const cell = getCellObject(r, colLabel, sheetName);
            const text = cell?.formula ?? cell?.value ?? "";
            if (String(text).includes(term)) {
              results.push({ sheetName, row: r, colLabel });
            }
          }
        }
        state.lastSearchResults = results;
        state.lastSearchIndex = -1;
        searchStatusEl.textContent = `${results.length} Treffer`;
      }
      if (!state.lastSearchResults.length) return;
      state.lastSearchIndex = (state.lastSearchIndex + 1) % state.lastSearchResults.length;
      const hit = state.lastSearchResults[state.lastSearchIndex];
      state.sheetName = hit.sheetName;
      state.selectedCell = { row: hit.row, colLabel: hit.colLabel, sheetName: hit.sheetName };
      state.selectionRange = null;
      syncFormulaBar();
      renderGrid();
    }

    async function performReplace(all) {
      const term = searchInput.value ?? "";
      const replacement = replaceInput.value ?? "";
      if (!term) return;

      const sheetName = state.sheetName;
      if (all) {
        const results = [];
        for (let r = 1; r <= state.maxRow; r++) {
          for (let cIdx = 0; cIdx <= state.maxColIndex; cIdx++) {
            const colLabel = indexToColLabel(cIdx);
            const cell = getCellObject(r, colLabel, sheetName);
            const text = cell?.formula ?? cell?.value ?? "";
            if (String(text).includes(term)) {
              results.push({ row: r, colLabel, sheetName, text, hasFormula: !!cell?.formula });
            }
          }
        }
        for (const hit of results) {
          const newText = String(hit.text).split(term).join(replacement);
          await saveCell(hit.row, hit.colLabel, newText, hit.sheetName, true);
        }
        searchStatusEl.textContent = `${results.length} ersetzt`;
        state.lastSearchResults = [];
        state.lastSearchIndex = -1;
      } else {
        if (!state.lastSearchResults.length) performSearch(true);
        if (!state.lastSearchResults.length) return;
        state.lastSearchIndex = (state.lastSearchIndex + 1) % state.lastSearchResults.length;
        const hit = state.lastSearchResults[state.lastSearchIndex];
        const cell = getCellObject(hit.row, hit.colLabel, hit.sheetName);
        const text = cell?.formula ?? cell?.value ?? "";
        const newText = String(text).replace(term, replacement);
        await saveCell(hit.row, hit.colLabel, newText, hit.sheetName, true);
        state.selectedCell = { row: hit.row, colLabel: hit.colLabel, sheetName: hit.sheetName };
        syncFormulaBar();
        renderGrid();
      }
    }

    freezeToggleBtn.addEventListener("click", () => {
      state.freezeFirstRowCol = !state.freezeFirstRowCol;
      freezeToggleBtn.classList.toggle("toggle-on", state.freezeFirstRowCol);
    });

    filterToggleBtn.addEventListener("click", () => {
      state.filterEnabled = !state.filterEnabled;
      filterToggleBtn.classList.toggle("toggle-on", state.filterEnabled);
    });

    exportXlsxBtn.addEventListener("click", () => {
      if (!state.currentModule) return;
      const wsData = [];
      const sheetName = state.sheetName;

      const headerRow = [];
      headerRow.push("");
      for (let cIdx = 0; cIdx <= state.maxColIndex; cIdx++) {
        headerRow.push(indexToColLabel(cIdx));
      }
      wsData.push(headerRow);

      for (let r = 1; r <= state.maxRow; r++) {
        const rowArr = [r];
        for (let cIdx = 0; cIdx <= state.maxColIndex; cIdx++) {
          const colLabel = indexToColLabel(cIdx);
          const cell = getCellObject(r, colLabel, sheetName);
          if (!cell) {
            rowArr.push("");
          } else if (cell.formula) {
            rowArr.push(cell.formula);
          } else {
            rowArr.push(cell.value ?? "");
          }
        }
        wsData.push(rowArr);
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      XLSX.writeFile(wb, `${state.currentModule.name || "modul"}.xlsx`);
    });

    exportCsvBtn.addEventListener("click", () => {
      if (!state.currentModule) return;
      const sheetName = state.sheetName;
      const lines = [];
      for (let r = 1; r <= state.maxRow; r++) {
        const rowArr = [];
        for (let cIdx = 0; cIdx <= state.maxColIndex; cIdx++) {
          const colLabel = indexToColLabel(cIdx);
          const cell = getCellObject(r, colLabel, sheetName);
          let val = "";
          if (cell) {
            val = cell.formula ?? cell.value ?? "";
          }
          const safe = `"${String(val).replace(/"/g, '""')}"`;
          rowArr.push(safe);
        }
        lines.push(rowArr.join(","));
      }
      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${state.currentModule.name || "modul"}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    themeToggleBtn.addEventListener("click", () => {
      state.darkMode = !state.darkMode;
      document.documentElement.setAttribute("data-theme", state.darkMode ? "dark" : "light");
      themeToggleBtn.classList.toggle("toggle-on", !state.darkMode);
    });


    const sidebar = document.querySelector(".layout .panel"); 
const toggleSidebarBtn = document.getElementById("toggleSidebar");

toggleSidebarBtn.addEventListener("click", () => {
  sidebar.classList.toggle("show-sidebar");
});

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert("Bitte zuerst einloggen.");
        window.location.href = "/login.html";
        return;
      }

      state.session = session;
      state.user = session.user;
      statusUserEl.textContent = `Angemeldet als ${state.user.email}`;

      let firmaId = localStorage.getItem("Tenra.currentFirmaId");
      let role = null;

      if (!firmaId) {
        const { data: fu, error } = await supabase
          .from("firmen_user")
          .select("firma_id, role, status")
          .eq("user_id", state.user.id)
          .eq("status", "accepted")
          .maybeSingle();

        if (error || !fu) {
          alert("Kein Firmenzugang gefunden.");
          return;
        }

        firmaId = fu.firma_id;
        role = fu.role;
        localStorage.setItem("Tenra.currentFirmaId", firmaId);
      } else {
        const { data: fu } = await supabase
          .from("firmen_user")
          .select("role, status")
          .eq("user_id", state.user.id)
          .eq("firma_id", firmaId)
          .eq("status", "accepted")
          .maybeSingle();

        role = fu?.role ?? null;
      }

      state.firma_id = firmaId;
      state.role = role;

      statusUserEl.textContent =
        `Angemeldet als ${state.user.email}` +
        (role ? ` ‚Äì Rolle: ${role}` : "");

      document.documentElement.setAttribute("data-theme", state.darkMode ? "dark" : "light");
      themeToggleBtn.classList.toggle("toggle-on", !state.darkMode);

      await loadModules();
      state.currentModule = null;
noModuleEl.style.display = "block";
moduleDetailEl.style.display = "none";
renderTutorial();

      await loadMatrixAbteilungenUndLinien();

    }
// ===========================
// Abteilungen-Popup √∂ffnen
// ===========================
function openDeptPopup(moduleId) {
  state.editModuleId = moduleId;
  
  const mod = state.modules.find(m => m.id == moduleId);
  const container = document.getElementById("deptList");
  
  const current = mod.abteilungen || [];
  const available = state.departments || []; // kommt aus loadMatrixAbteilungenUndLinien()

  container.innerHTML = available.map(dep => `
    <label style="display:block;margin-bottom:6px;">
      <input type="checkbox" value="${dep.id}"
        ${current.includes(dep.id) ? "checked" : ""}>
      ${dep.name}
    </label>
  `).join("");

  document.getElementById("deptPopup").style.display = "flex";
}

document.getElementById("deptCancel").onclick = () => {
  document.getElementById("deptPopup").style.display = "none";
};

// ===========================
// Abteilungen speichern
// ===========================
document.getElementById("deptSave").onclick = async () => {
  const checks = [...document.querySelectorAll("#deptList input:checked")];
  const arr = checks.map(c => c.value);

  const id = state.editModuleId;

  const { error } = await supabase
    .from("excel_modules")
    .update({ abteilungen: arr })
    .eq("id", id);

  if (error) {
    alert("Fehler beim Speichern der Abteilungen.");
    return;
  }

  const mod = state.modules.find(m => m.id == id);
  mod.abteilungen = arr;

  document.getElementById("deptPopup").style.display = "none";
  renderModuleList();
};

document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement) {
    document.body.classList.remove("is-fullscreen");
  }
});

document.addEventListener("keydown", (e) => {
  if ((e.key === "F11") || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "f")) {
    e.preventDefault();
    document.getElementById("fullscreenBtn").click();
  }
});

document.addEventListener("keydown", (e) => {
  if (document.body.classList.contains("is-fullscreen")) {
    // ESC soll NICHT Fullscreen beenden wenn man gerade editiert
    const active = document.activeElement;
    if (active && active.tagName === "TD" && active.isContentEditable) {
      if (e.key === "Escape") {
        e.stopImmediatePropagation();
        e.preventDefault();
        active.blur();   // beendet nur edit ‚Äì nicht Fullscreen
      }
    }
  }
});

    init();
  </script>
  <!-- Untermodul-Popup -->
<div id="popup-under" style="
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;">
  
  <div style="
    background: #1c1f26;
    padding: 20px;
    border: 1px solid var(--panel-border-dark);
    border-radius: 10px;
    width: 320px;">
    
    <h3 style="margin-top:0; color:var(--accent); font-size:18px;">Untermodul erstellen?</h3>
    <p style="margin-bottom:12px;">Dieses Modul ist ein Hauptmodul. M√∂chtest du ein Untermodul hinzuf√ºgen?</p>

    <input id="under-name" 
           placeholder="Name des Untermoduls" 
           style="width:100%; margin-top:8px; padding:8px; border-radius:8px; border:1px solid var(--panel-border-dark);" />

    <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
      <button id="popup-no" class="small ghost">Abbrechen</button>
      <button id="popup-yes" class="small" style="background:var(--accent);font-weight:600;">Erstellen</button>
    </div>
  </div>
</div>



<!-- Popup: Abteilungen setzen -->
<div id="deptPopup" class="popup hidden" style="
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.45); backdrop-filter:blur(4px); z-index:99999;
">
  <div style="
    background:var(--panel-dark);
    padding:18px; border-radius:12px;
    width:300px; border:1px solid var(--panel-border-dark);
  ">
    <h3 style="margin-top:0; color:var(--accent);">Abteilungen w√§hlen</h3>
    <div id="deptList"></div>

    <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="deptCancel" class="small ghost">Abbrechen</button>
      <button id="deptSave" class="small">Speichern</button>
    </div>
  </div>
</div>

</body>
</html>
