<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tenra ‚Äì Excel-Module</title>

  <!-- SheetJS f√ºr Excel-Parsing (stellt window.XLSX bereit) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      margin: 0;
      background: #0b0d10;
      color: #f5f7fb;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 6px;
    }

    h2 {
      font-size: 20px;
      margin-top: 20px;
      margin-bottom: 6px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .status {
      font-size: 13px;
      color: #a0a8b2;
    }

    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .sidebar,
    .main {
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(16px) saturate(130%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    button {
      padding: 8px 14px;
      cursor: pointer;
      background: #0c7b48;
      color: white;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:hover {
      background: #089d57;
    }
    button.small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
    }
    button.danger {
      background: #c0392b;
    }
    button.danger:hover {
      background: #e74c3c;
    }

    .upload-area {
      margin-bottom: 10px;
    }

    .module-list {
      margin-top: 8px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .module-item {
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 14px;
      background: rgba(0,0,0,0.1);
      transition: 0.15s all;
    }
    .module-item:hover {
      background: rgba(255,255,255,0.04);
    }
    .module-item.active {
      background: rgba(0, 122, 255, 0.15);
      border-color: #0c7b48;
    }
    .module-item span.name {
      font-weight: 600;
      display: block;
      color: #f5f7fb;
    }
    .module-item span.meta {
      font-size: 12px;
      color: #a0a8b2;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(12, 123, 72, 0.2);
      color: #4ade80;
      font-size: 11px;
      margin-top: 4px;
    }

    .info-line {
      font-size: 13px;
      color: #a0a8b2;
      margin-bottom: 6px;
    }

    .muted {
      color: #a0a8b2;
      font-size: 13px;
    }

    .search-bar {
      margin: 10px 0;
    }

    .search-bar input {
      padding: 8px 10px;
      width: 260px;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      font-size: 14px;
      background: rgba(0,0,0,0.25);
      color: #f5f7fb;
      outline: none;
    }
    .search-bar input::placeholder {
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: rgba(0,0,0,0.2);
      font-size: 13px;
    }
    table th, table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
    }
    table th {
      background: rgba(255,255,255,0.03);
      font-weight: 600;
      color: #a0a8b2;
    }

    .input-row {
      margin-top: 14px;
      padding: 10px;
      background: rgba(0,0,0,0.35);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .input-row input {
      padding: 6px 8px;
      width: 220px;
      margin: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px;
      font-size: 13px;
      background: rgba(0,0,0,0.3);
      color: #f5f7fb;
      outline: none;
    }
    .input-row input::placeholder {
      color: #6b7280;
    }

    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div>
      <h1>üì¶ Excel-Module</h1>
      <div class="status" id="statusUser">Lade Benutzer‚Ä¶</div>
    </div>
    <div>
      <button onclick="window.location.href='/Dashboard.html'">‚Üê Zur √úbersicht</button>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar: Module + Upload -->
    <div class="sidebar">
      <div class="upload-area">
        <button id="uploadBtn">‚ûï Neues Modul aus Excel</button>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
      <div class="info-line">
        <strong>Module dieser Firma:</strong>
      </div>
      <div id="moduleList" class="module-list">
        Lade Module‚Ä¶
      </div>
    </div>

    <!-- Main: Modul-Details + Tabelle -->
    <div class="main">
      <div id="noModuleSelected">
        <p class="muted">
          Kein Modul ausgew√§hlt. W√§hle links ein Modul oder lade eine Excel-Datei hoch.<br>
          Die Spalten√ºberschriften deiner Excel werden automatisch als Felder √ºbernommen.
        </p>
      </div>

      <div id="moduleDetail" style="display:none;">
        <div class="module-header">
          <div>
            <h2 id="moduleTitle">Modul</h2>
            <div class="info-line" id="moduleMeta"></div>
          </div>
          <button class="danger small" id="deleteModuleBtn">Modul l√∂schen</button>
        </div>

        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Suche in den Daten‚Ä¶" />
        </div>

        <div id="tableContainer">Lade Daten‚Ä¶</div>

        <h3 style="margin-top:18px;">Neue Zeile hinzuf√ºgen</h3>
        <div class="input-row" id="insertForm"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ===== Supabase Setup =====
  const SUPABASE_URL = "https://lajqzmlhcsxhpfbhmlxe.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhanF6bWxoY3N4aHBmYmhtbHhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzkzMTksImV4cCI6MjA3NTQxNTMxOX0.3fjdlh2Ozf0Ku7-s2459qYFCzQBBw49tzMFM-vFgmeg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supabase = supabase; // Debug-Hilfe in der Konsole

  const XLSX = window.XLSX;

  // ===== Globaler State =====
  const state = {
    session: null,
    user: null,
    firma_id: null,
    role: null,
    modules: [],
    currentModule: null,
    fields: [],
    rows: []
  };

  // ===== DOM-Elemente =====
  const statusUserEl   = document.getElementById("statusUser");
  const moduleListEl   = document.getElementById("moduleList");
  const moduleDetailEl = document.getElementById("moduleDetail");
  const noModuleEl     = document.getElementById("noModuleSelected");
  const moduleTitleEl  = document.getElementById("moduleTitle");
  const moduleMetaEl   = document.getElementById("moduleMeta");
  const tableContainer = document.getElementById("tableContainer");
  const insertFormEl   = document.getElementById("insertForm");
  const searchInputEl  = document.getElementById("searchInput");
  const uploadBtn      = document.getElementById("uploadBtn");
  const excelInput     = document.getElementById("excelInput");
  const deleteModuleBtn = document.getElementById("deleteModuleBtn");

  // ===== Session + Firma laden =====
  async function init() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert("Bitte zuerst einloggen.");
        window.location.href = "/login.html";
        return;
      }
      state.session = session;
      state.user = session.user;

      statusUserEl.textContent = `Angemeldet als ${state.user.email}`;

      // Firma aus localStorage oder Datenbank bestimmen
      let firmaId = localStorage.getItem("Tenra.currentFirmaId");

      if (!firmaId) {
        const { data: fu, error: fuErr } = await supabase
          .from("firmen_user")
          .select("firma_id, role, status")
          .eq("user_id", state.user.id)
          .eq("status", "accepted")
          .maybeSingle();

        if (fuErr) {
          console.error(fuErr);
          alert("Fehler beim Laden der Firmenzuordnung.");
          return;
        }
        if (!fu) {
          alert("Kein Firmenzugang gefunden.");
          return;
        }

        firmaId = fu.firma_id;
        state.role = fu.role;
        localStorage.setItem("Tenra.currentFirmaId", firmaId);
      } else {
        const { data: fu, error: fuErr } = await supabase
          .from("firmen_user")
          .select("role, status")
          .eq("user_id", state.user.id)
          .eq("firma_id", firmaId)
          .maybeSingle();

        if (fuErr) {
          console.error(fuErr);
          alert("Fehler beim Laden der Firmenzuordnung.");
          return;
        }
        if (!fu || fu.status !== "accepted") {
          alert("Kein aktiver Firmenzugang f√ºr diese Firma.");
          return;
        }
        state.role = fu.role;
      }

      state.firma_id = firmaId;
      statusUserEl.textContent = `Angemeldet als ${state.user.email} ‚Äì Rolle: ${state.role}`;

      await loadModules();
    } catch (err) {
      console.error(err);
      alert("Unerwarteter Fehler beim Initialisieren.");
    }
  }

  // ===== Module laden & anzeigen =====
  async function loadModules() {
    moduleListEl.textContent = "Lade Module‚Ä¶";

    const { data, error } = await supabase
      .from("excel_modules")
      .select("*")
      .eq("firma_id", state.firma_id)
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      moduleListEl.textContent = "Fehler beim Laden der Module.";
      return;
    }

    state.modules = data || [];
    renderModuleList();
  }

  function renderModuleList() {
    if (!state.modules.length) {
      moduleListEl.innerHTML = "<p class='muted'>Noch keine Module vorhanden.</p>";
      moduleDetailEl.style.display = "none";
      noModuleEl.style.display = "block";
      return;
    }

    moduleListEl.innerHTML = state.modules.map(m => {
      const isActive = state.currentModule && state.currentModule.id === m.id;
      const createdAt = m.created_at ? new Date(m.created_at).toLocaleString() : "";
      return `
        <div class="module-item ${isActive ? "active" : ""}" data-id="${m.id}">
          <span class="name">${m.name}</span>
          <span class="meta">${m.excel_filename || ""}</span>
          <span class="meta">${createdAt}</span>
          <span class="badge">Excel-Modul</span>
        </div>
      `;
    }).join("");

    moduleListEl.querySelectorAll(".module-item").forEach(el => {
      el.addEventListener("click", () => {
        const id = el.getAttribute("data-id");
        selectModule(id);
      });
    });
  }

  async function selectModule(id) {
    const module = state.modules.find(m => m.id === id);
    if (!module) return;

    state.currentModule = module;
    renderModuleList();

    noModuleEl.style.display = "none";
    moduleDetailEl.style.display = "block";

    moduleTitleEl.textContent = module.name;
    moduleMetaEl.textContent =
      (module.description || "") +
      (module.excel_filename ? ` | Datei: ${module.excel_filename}` : "");

    searchInputEl.value = "";
    await loadFieldsForModule();
    await loadRowsForModule();
  }

  // ===== Felder laden + Insert-Form =====
  async function loadFieldsForModule() {
    insertFormEl.innerHTML = "Lade Felder‚Ä¶";

    const { data, error } = await supabase
      .from("excel_module_fields")
      .select("*")
      .eq("module_id", state.currentModule.id)
      .order("position", { ascending: true });

    if (error) {
      console.error(error);
      insertFormEl.innerHTML = "<p class='muted'>Fehler beim Laden der Felder.</p>";
      return;
    }

    state.fields = data || [];
    renderInsertForm();
  }

  function renderInsertForm() {
    if (!state.fields.length) {
      insertFormEl.innerHTML = "<p class='muted'>Keine Felder f√ºr dieses Modul vorhanden.</p>";
      return;
    }

    insertFormEl.innerHTML = state.fields.map(f => `
      <input
        type="text"
        id="field_${f.name}"
        placeholder="${f.label}"
      >
    `).join("");

    const btn = document.createElement("button");
    btn.textContent = "Zeile hinzuf√ºgen";
    btn.addEventListener("click", addRow);
    insertFormEl.appendChild(document.createElement("br"));
    insertFormEl.appendChild(btn);
  }

  // ===== Zeilen laden + Tabelle =====
  async function loadRowsForModule() {
    tableContainer.innerHTML = "Lade Daten‚Ä¶";

    const { data, error } = await supabase
      .from("excel_module_rows")
      .select("*")
      .eq("module_id", state.currentModule.id)
      .order("created_at", { ascending: true });

    if (error) {
      console.error(error);
      tableContainer.innerHTML = "<p class='muted'>Fehler beim Laden der Daten.</p>";
      return;
    }

    state.rows = data || [];
    renderTable();
  }

  function renderTable() {
    if (!state.rows.length) {
      tableContainer.innerHTML = "<p class='muted'>Noch keine Daten in diesem Modul.</p>";
      return;
    }

    const search = (searchInputEl.value || "").toLowerCase();
    const filtered = state.rows.filter(r => {
      const s = JSON.stringify(r.data || {}).toLowerCase();
      return s.includes(search);
    });

    if (!filtered.length) {
      tableContainer.innerHTML = "<p class='muted'>Keine Zeilen entsprechen der Suche.</p>";
      return;
    }

    let html = "<table><thead><tr>";
    state.fields.forEach(f => {
      html += `<th>${f.label}</th>`;
    });
    html += `<th>Aktionen</th>`;
    html += "</tr></thead><tbody>";

    filtered.forEach(r => {
      html += "<tr>";
      state.fields.forEach(f => {
        const val = r.data && r.data[f.label] !== undefined ? r.data[f.label] : "";
        html += `<td>${val}</td>`;
      });

      const canEdit =
        state.role === "owner" ||
        state.role === "admin" ||
        r.created_by === (state.user && state.user.id);

      if (canEdit) {
        html += `
          <td>
            <button class="small" data-action="edit" data-id="${r.id}">‚úè</button>
            <button class="small danger" data-action="delete" data-id="${r.id}">üóë</button>
          </td>
        `;
      } else {
        html += `<td><span class="muted">Nur lesen</span></td>`;
      }

      html += "</tr>";
    });

    html += "</tbody></table>";
    tableContainer.innerHTML = html;

    // Button-Events
    tableContainer.querySelectorAll("button[data-action]").forEach(btn => {
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      btn.addEventListener("click", () => {
        if (action === "edit") editRow(Number(id));
        if (action === "delete") deleteRow(Number(id));
      });
    });
  }

  // ===== Zeile hinzuf√ºgen =====
  async function addRow() {
    if (!state.currentModule || !state.fields.length) return;

    let obj = {};
    state.fields.forEach(f => {
      const input = document.getElementById("field_" + f.name);
      obj[f.label] = input ? input.value : null;
    });

    const { error } = await supabase.from("excel_module_rows").insert({
      module_id: state.currentModule.id,
      firma_id: state.firma_id,
      data: obj,
      created_by: state.user.id
    });

    if (error) {
      console.error(error);
      alert("Fehler beim Einf√ºgen der Zeile.");
      return;
    }

    state.fields.forEach(f => {
      const input = document.getElementById("field_" + f.name);
      if (input) input.value = "";
    });

    await loadRowsForModule();
  }

  // ===== Zeile l√∂schen =====
  async function deleteRow(id) {
    if (!confirm("Zeile wirklich l√∂schen?")) return;

    const { error } = await supabase
      .from("excel_module_rows")
      .delete()
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("Fehler beim L√∂schen der Zeile.");
      return;
    }

    await loadRowsForModule();
  }

  // ===== Zeile bearbeiten =====
  async function editRow(id) {
    const row = state.rows.find(r => r.id === id);
    if (!row) return;

    const canEdit =
      state.role === "owner" ||
      state.role === "admin" ||
      row.created_by === (state.user && state.user.id);

    if (!canEdit) {
      alert("Keine Berechtigung zum Bearbeiten dieser Zeile.");
      return;
    }

    let newData = { ...(row.data || {}) };

    for (let f of state.fields) {
      const currentVal = newData[f.label] ?? "";
      const val = prompt(`Neuer Wert f√ºr "${f.label}":`, currentVal);
      if (val === null) return;
      newData[f.label] = val;
    }

    const { error } = await supabase
      .from("excel_module_rows")
      .update({ data: newData })
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("Fehler beim Aktualisieren der Zeile.");
      return;
    }

    await loadRowsForModule();
  }

  // ===== Modul komplett l√∂schen =====
  deleteModuleBtn.addEventListener("click", async () => {
    if (!state.currentModule) return;
    if (!confirm(`Modul "${state.currentModule.name}" inkl. aller Daten wirklich l√∂schen?`)) return;

    const id = state.currentModule.id;

    // Reihen und Felder l√∂schen (einfach, ohne Transaktion)
    await supabase.from("excel_module_rows").delete().eq("module_id", id);
    await supabase.from("excel_module_fields").delete().eq("module_id", id);
    const { error } = await supabase.from("excel_modules").delete().eq("id", id);

    if (error) {
      console.error(error);
      alert("Fehler beim L√∂schen des Moduls.");
      return;
    }

    state.currentModule = null;
    await loadModules();
  });

  // ===== Excel-Upload ‚Üí Modul erzeugen =====
  uploadBtn.addEventListener("click", () => {
    excelInput.click();
  });

  excelInput.addEventListener("change", handleExcelUpload);

  async function handleExcelUpload(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    if (!state.firma_id || !state.user) {
      alert("Session noch nicht geladen.");
      evt.target.value = "";
      return;
    }

    if (!XLSX) {
      alert("Excel-Bibliothek (XLSX) konnte nicht geladen werden.");
      evt.target.value = "";
      return;
    }

    const reader = new FileReader();
    reader.readAsArrayBuffer(file);

    reader.onload = async function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });

        const sheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];

        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (json.length < 2) {
          alert("Excel hat keine Daten (mindestens √úberschrift + eine Zeile).");
          return;
        }

        const headers = json[0];
        const rows = json.slice(1);

        const moduleName = prompt("Name f√ºr dieses Modul:");
        if (!moduleName) return;

        // 1) Modul
        const { data: module, error: modErr } = await supabase
          .from("excel_modules")
          .insert({
            firma_id: state.firma_id,
            name: moduleName,
            excel_filename: file.name,
            excel_sheet_name: sheetName,
            created_by: state.user.id
          })
          .select()
          .single();

        if (modErr) {
          console.error(modErr);
          alert("Fehler beim Anlegen des Moduls.");
          return;
        }

        const module_id = module.id;

        // 2) Felder
        const fieldsToInsert = headers.map((h, idx) => ({
          module_id,
          name: String(h || "")
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "_")
            .replace(/[^a-z0-9_]/g, ""),
          label: String(h || ""),
          type: "text",
          position: idx,
          is_required: false
        }));

        const { error: fieldErr } = await supabase
          .from("excel_module_fields")
          .insert(fieldsToInsert);

        if (fieldErr) {
          console.error(fieldErr);
          alert("Fehler beim Anlegen der Felder.");
          return;
        }

        // 3) Zeilen
        const rowInserts = rows.map(r => {
          let obj = {};
          headers.forEach((h, idx) => {
            obj[String(h || "")] = r[idx] ?? null;
          });

          return {
            module_id,
            firma_id: state.firma_id,
            data: obj,
            created_by: state.user.id
          };
        });

        if (rowInserts.length > 0) {
          const { error: rowsErr } = await supabase
            .from("excel_module_rows")
            .insert(rowInserts);

          if (rowsErr) {
            console.error(rowsErr);
            alert("Fehler beim Anlegen der Datenzeilen.");
            return;
          }
        }

        await loadModules();
        await selectModule(module_id);

        alert("Excel-Modul wurde erfolgreich erstellt.");
      } catch (err) {
        console.error(err);
        alert("Fehler beim Verarbeiten der Excel-Datei.");
      } finally {
        evt.target.value = "";
      }
    };
  }

  // Suche live binden
  searchInputEl.addEventListener("input", () => {
    renderTable();
  });

  // Start
  init();
</script>

</body>
</html>
